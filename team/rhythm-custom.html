<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ë“¬ í‚¤ë³´ë“œ ê²Œì„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #222;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ ë†’ì´ì™€ ë„ˆë¹„ë¥¼ ê³ ì •í•˜ì—¬ ë ˆì¸ ë¹„ìœ¨ ìœ ì§€ */
        .game-container {
            width: 500px; 
            height: 600px;
            background: #333;
            border: 4px solid #555;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .header {
            width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #1e1e1e;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .stats span {
            font-size: 1.2rem;
            margin-left: 20px;
            color: #ccc;
        }

        .stats strong {
            color: #ffcc00;
        }

        /* ë ˆì¸ ìŠ¤íƒ€ì¼ */
        .lane-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .lane {
            flex-grow: 1;
            height: 100%;
            border-right: 1px solid #444;
            position: relative;
        }
        .lane:last-child {
            border-right: none;
        }

        /* ëª…í™•í•œ íˆíŠ¸ ì¡´ ì˜ì—­ (ë…¸íŠ¸ í¬ê¸°ë³´ë‹¤ í¬ê²Œ) */
        .hit-zone {
            position: absolute;
            bottom: 0;
            width: 100%;
            /* ë…¸íŠ¸ ë†’ì´ê°€ 30pxì´ë¯€ë¡œ, íŒì • ë²”ìœ„ë¥¼ í¬í•¨í•˜ì—¬ ë„‰ë„‰í•˜ê²Œ ì„¤ì • */
            height: 80px; 
            background: rgba(0, 255, 0, 0.05); 
            z-index: 10;
        }
        
        /* ë…¸íŠ¸ ë°”ë‹¥ì´ ë‹¿ëŠ” ëª…í™•í•œ íŒì •ì„  */
        .hit-line {
            position: absolute;
            top: 0; 
            width: 100%;
            height: 4px; /* ë” ëˆˆì— ì˜ ë„ê²Œ */
            background-color: #0f0; 
            box-shadow: 0 0 10px #0f0;
            z-index: 11;
        }

        /* í‚¤ ì…ë ¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .key-button {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px; /* hit-zoneê³¼ ë™ì¼ ë†’ì´ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            transition: background 0.05s;
            pointer-events: none;
        }

        /* í‚¤ ì…ë ¥ ì‹œ ê°•ì¡° íš¨ê³¼ */
        .key-button.pressed {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        /* ë…¸íŠ¸ ìŠ¤íƒ€ì¼: ë†’ì´ 30pxë¡œ ì„¤ì • */
        .note {
            position: absolute;
            width: 90%;
            height: 30px; 
            background: linear-gradient(135deg, #f06, #ff0066);
            border-radius: 5px;
            left: 5%;
            top: 0;
        }

        /* íŒì • íš¨ê³¼ */
        #judgment {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            opacity: 0;
            transition: all 0.1s ease-out;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            z-index: 100;
        }
        .perfect { color: #00ff00; }
        .good { color: #ffeb3b; font-size: 2.5rem; }
        .soso { color: #00bcd4; font-size: 2.3rem; }
        .miss { color: #ff0000; font-size: 2rem; }

        /* ì‹œì‘ í™”ë©´ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        #start-screen button {
            padding: 10px 20px;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #667eea;
            color: white;
            margin-top: 20px;
            transition: background 0.2s;
        }
        #start-screen button:hover {
            background: #764ba2;
        }
        
        #key-input-field {
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 250px;
            text-align: center;
            font-size: 1rem;
        }

        .settings-info {
            margin-top: 15px;
            font-size: 1rem;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>ğŸµ Custom Rhythm Game</h2>
        <div class="stats">
            <span>ë‚¨ì€ ì‹œê°„: <strong id="time-left">03:00</strong></span>
            <span>SCORE: <strong id="score">0</strong></span>
            <span>COMBO: <strong id="combo">0</strong></span>
        </div>
    </div>
    
    <div class="game-container">
        <div id="start-screen">
            <h1>Rhythm Keyboard Game</h1>
            <p>ê²Œì„ì„ ì‹œì‘í•˜ê¸° ì „ì—, **ì‚¬ìš©í•  5ê°œì˜ í‚¤**ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
            <input type="text" id="key-input-field" placeholder="ì˜ˆ: A,S,D,F,G (ì‰¼í‘œë¡œ êµ¬ë¶„)" value="A, S, D, F, G">
            <p class="settings-info">í‚¤ëŠ” 5ê°œ, í•œ ê¸€ìì—¬ì•¼ í•˜ë©° ì¤‘ë³µë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <button onclick="configureAndStartGame()">ê²Œì„ ì‹œì‘</button>
        </div>

        <div class="lane-container" id="lane-container">
            </div>

        <div id="judgment"></div>
    </div>

    <script>
        // --- ê²Œì„ ì„¤ì • ---
        let KEYS = []; 
        let LANE_COUNT = 0;
        const GAME_DURATION = 180; // 3ë¶„ = 180ì´ˆ
        const NOTE_SPEED = 3; 
        const NOTE_HEIGHT = 30; // ë…¸íŠ¸ ë†’ì´ 30pxë¡œ í†µì¼
        const NOTE_INTERVAL_MS = 600; 
        const GAME_CONTAINER_HEIGHT = 600;
        const HIT_ZONE_HEIGHT = 80;

        // íŒì • ê¸°ì¤€ (px): ë…¸íŠ¸ ë°”ë‹¥ê³¼ íˆíŠ¸ ë¼ì¸ì˜ ê±°ë¦¬
        const PERFECT_WINDOW = 10; // Â±10px
        const GOOD_WINDOW = 20;  // Â±20px
        const SOSO_WINDOW = 30;  // Â±30px

        // HIT_LINEì˜ Yì¢Œí‘œ (ë°”ë‹¥ì—ì„œ 80px ìœ„, ì¦‰ 520px)
        const HIT_LINE_Y = GAME_CONTAINER_HEIGHT - HIT_ZONE_HEIGHT;

        // --- ê²Œì„ ìƒíƒœ ---
        let score = 0;
        let combo = 0;
        let timeLeft = GAME_DURATION;
        let gameRunning = false;
        let animationFrameId = null;
        let noteGeneratorInterval = null;
        let timerInterval = null;

        // --- DOM ìš”ì†Œ ---
        const gameContainer = document.querySelector('.game-container');
        const laneContainer = document.getElementById('lane-container');
        const scoreElement = document.getElementById('score');
        const comboElement = document.getElementById('combo');
        const timeLeftElement = document.getElementById('time-left');
        const judgmentElement = document.getElementById('judgment');
        const startScreen = document.getElementById('start-screen');
        
        let noteMap = {}; 

        // --- ì´ˆê¸°í™” ë° ì„¤ì • ---

        function configureAndStartGame() {
            const inputField = document.getElementById('key-input-field');
            const newKeysInput = inputField.value;

            if (!newKeysInput) {
                alert("ì‚¬ìš©í•  5ê°œì˜ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const keyArray = newKeysInput.toUpperCase().split(',').map(k => k.trim()).filter(k => k.length === 1);
            const uniqueKeys = [...new Set(keyArray)];

            if (uniqueKeys.length !== 5) {
                alert("5ê°œì˜ ê³ ìœ í•œ í‚¤ë¥¼ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì •í™•íˆ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ìœ íš¨í•œ í‚¤: " + uniqueKeys.length + "ê°œ)");
                return;
            }
            
            KEYS = uniqueKeys;
            LANE_COUNT = KEYS.length;
            
            initGameContainer();
            startGame();
        }

        function initGameContainer() {
            laneContainer.innerHTML = ''; 
            noteMap = {};

            KEYS.forEach((key) => {
                const lane = document.createElement('div');
                lane.classList.add('lane');
                lane.id = `lane-${key}`;
                
                const hitZone = document.createElement('div');
                hitZone.classList.add('hit-zone');
                
                const hitLine = document.createElement('div');
                hitLine.classList.add('hit-line');

                const keyButton = document.createElement('div');
                keyButton.classList.add('key-button');
                keyButton.id = `key-button-${key}`;
                keyButton.textContent = key;
                
                hitZone.appendChild(hitLine); 
                lane.appendChild(hitZone);
                lane.appendChild(keyButton);
                laneContainer.appendChild(lane);

                noteMap[key] = []; 
            });
        }

        function startGame() {
            if (gameRunning) return;
            score = 0;
            combo = 0;
            timeLeft = GAME_DURATION;
            scoreElement.textContent = 0;
            comboElement.textContent = 0;
            
            startScreen.style.display = 'none'; 
            gameRunning = true;
            
            timerInterval = setInterval(updateTimer, 1000);
            noteGeneratorInterval = setInterval(generateNote, NOTE_INTERVAL_MS);
            animationFrameId = requestAnimationFrame(moveNotes);

            document.addEventListener('keydown', handleKeyPress);
            document.addEventListener('keyup', handleKeyRelease);
        }

        function updateTimer() {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timeLeftElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft <= 0) {
                endGame();
            }
        }

        function endGame() {
            if (!gameRunning) return;
            gameRunning = false;
            clearInterval(noteGeneratorInterval);
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrameId);

            document.removeEventListener('keydown', handleKeyPress);
            document.removeEventListener('keyup', handleKeyRelease);
            
            alert(`ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜: ${score}, ìµœê³  ì½¤ë³´: ${combo}`);
            startScreen.style.display = 'flex';
        }

        // --- ê²Œì„ ë¡œì§: ë…¸íŠ¸ ìƒì„± ë° ì´ë™ ---

        function generateNote() {
            if (!gameRunning || KEYS.length === 0) return;
            
            const randomKey = KEYS[Math.floor(Math.random() * LANE_COUNT)];
            const targetLane = document.getElementById(`lane-${randomKey}`);

            if (!targetLane) return; 
            
            const note = document.createElement('div');
            note.classList.add('note');
            note.style.top = '0px'; 
            
            targetLane.appendChild(note);
            noteMap[randomKey].push(note);
        }

        function moveNotes() {
            if (!gameRunning) {
                animationFrameId = null;
                return;
            }

            KEYS.forEach(key => {
                const notes = noteMap[key];
                
                for (let i = notes.length - 1; i >= 0; i--) {
                    const note = notes[i];
                    const currentTop = parseFloat(note.style.top);
                    const newTop = currentTop + NOTE_SPEED;
                    
                    note.style.top = `${newTop}px`;

                    // MISS íŒì •: ë…¸íŠ¸ ë°”ë‹¥ì´ SOSO ìœˆë„ìš°ë¥¼ ì™„ì „íˆ ì§€ë‚˜ì¹œ ê²½ìš°
                    const noteBottomY = currentTop + NOTE_HEIGHT;

                    if (noteBottomY > HIT_LINE_Y + SOSO_WINDOW) {
                        note.remove();
                        notes.splice(i, 1);
                        processMiss(); // ë†“ì¹œ ë…¸íŠ¸ë¡œ ì¸í•œ MISS
                    }
                }
            });

            animationFrameId = requestAnimationFrame(moveNotes);
        }
        
        // --- ê²Œì„ ë¡œì§: í‚¤ ì…ë ¥ ì²˜ë¦¬ ---

        function handleKeyPress(e) {
            if (!gameRunning) return;
            const pressedKey = e.key.toUpperCase();
            
            if (KEYS.includes(pressedKey)) {
                const keyButton = document.getElementById(`key-button-${pressedKey}`);
                if (keyButton) {
                    keyButton.classList.add('pressed');
                }
                
                checkHit(pressedKey);
                
                e.preventDefault(); 
            }
        }
        
        function handleKeyRelease(e) {
            if (!gameRunning) return;
            const releasedKey = e.key.toUpperCase();
            
            if (KEYS.includes(releasedKey)) {
                const keyButton = document.getElementById(`key-button-${releasedKey}`);
                if (keyButton) {
                    keyButton.classList.remove('pressed');
                }
            }
        }

        function checkHit(key) {
            const notes = noteMap[key];
            
            if (notes.length > 0) {
                const note = notes[0];
                const noteTopY = parseFloat(note.style.top);
                const noteBottomY = noteTopY + NOTE_HEIGHT;
                
                // ë…¸íŠ¸ì˜ ë°”ë‹¥ê³¼ íŒì •ì„ ì˜ ê±°ë¦¬
                const distance = Math.abs(HIT_LINE_Y - noteBottomY);

                let judgment = null;
                let points = 0;

                if (distance <= PERFECT_WINDOW) {
                    judgment = 'PERFECT';
                    points = 300;
                } else if (distance <= GOOD_WINDOW) {
                    judgment = 'GOOD';
                    points = 150;
                } else if (distance <= SOSO_WINDOW) {
                    judgment = 'SOSO';
                    points = 50;
                }
                
                if (judgment) {
                    note.remove();
                    notes.shift(); 
                    processHit(points);
                    displayJudgment(judgment);
                } else {
                    // í‚¤ë¥¼ ëˆŒë €ì§€ë§Œ ìœ íš¨ ë²”ìœ„(SOSO_WINDOW) ë°–ì¸ ê²½ìš° -> Miss ì²˜ë¦¬
                    processMiss(); 
                }
            } 
        }

        function processHit(points) {
            score += points;
            combo++;
            scoreElement.textContent = score;
            comboElement.textContent = combo;
        }
        
        function processMiss() {
            combo = 0;
            score -= 100; // ì ìˆ˜ 100ì  ì°¨ê° (ìŒìˆ˜ í—ˆìš©)
            comboElement.textContent = combo;
            scoreElement.textContent = score;
            
            displayJudgment('MISS');
        }

        function displayJudgment(judgment) {
            judgmentElement.textContent = judgment;
            judgmentElement.className = ''; 
            judgmentElement.classList.add('judgment', judgment.toLowerCase());
            judgmentElement.style.opacity = 1;
            
            setTimeout(() => {
                judgmentElement.style.opacity = 0;
            }, 100);
        }
    </script>
</body>
</html>