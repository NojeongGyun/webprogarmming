<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë˜ ìŠ¤í¬ì¸  í”Œë«í¼</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (ì•„ì´ì½˜) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Maps -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBz9unITV_n6SSy1EFxf5RqwQMFPRb1KJU&libraries=places&callback=initMap"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8fafc; }
        .feature-card { transition: all 0.3s ease; }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        #map { height: 70vh; border-radius: 0.75rem; z-index: 1; }
        @media (max-width: 768px) { #map { height: 50vh; } } /* ëª¨ë°”ì¼ ì§€ë„ ë†’ì´ ì¡°ì • */
        
        .calendar-day { aspect-ratio: 1; cursor: pointer; transition: all 0.2s; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 0.5rem; }
        .calendar-day:hover { background-color: #f1f5f9; }
        .calendar-day.selected { background-color: #4f46e5; color: white; font-weight: bold; }
        .calendar-day.today { border: 2px solid #4f46e5; }
        .calendar-dot { width: 6px; height: 6px; background-color: #10b981; border-radius: 50%; margin-top: 4px; }
        .calendar-day.selected .calendar-dot { background-color: #ffffff; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .gm-style-iw { font-family: inherit !important; padding: 0 !important; }
        .gm-style-iw-d { overflow: hidden !important; }
        
        /* Tab Styles */
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: bold; background-color: #f8fafc; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; }
        .tab-inactive:hover { color: #4f46e5; background-color: #f8fafc; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Range Slider */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ec4899; margin-top: -6px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        
        /* Quest Styles */
        .quest-card { transition: all 0.2s; border: 2px solid transparent; }
        .quest-card:hover { transform: scale(1.02); }
        .quest-completed { background-color: #ecfdf5; border-color: #10b981; opacity: 0.8; }
        .quest-completed .quest-icon { color: #10b981; background-color: #d1fae5; }
        .quest-completed .quest-title { text-decoration: line-through; color: #059669; }

        /* Star Rating Slider */
        .star-range { -webkit-appearance: none; appearance: none; width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; outline: none; }
        .star-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #fbbf24; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .star-display i { transition: color 0.2s; }

        /* Mobile Menu Animation */
        #mobile-menu { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #mobile-menu.open { max-height: 100vh; opacity: 1; }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#4f46e5', secondary: '#64748b' } } } }
    </script>
</head>
<body class="text-slate-800">
    <!-- HEADER -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center relative">
            <!-- Logo -->
            <a href="#" onclick="window.app.router('home')" class="text-2xl font-bold text-primary tracking-tight">
                <i class="fa-solid fa-dumbbell mr-2"></i>Sports Pro
            </a>
            
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex space-x-6 font-medium text-sm text-slate-600">
                <a href="#" onclick="window.app.router('home')" class="hover:text-primary">í™ˆ</a>
                <a href="#" onclick="window.app.router('map')" class="hover:text-primary">ì‹œì„¤ ì°¾ê¸°</a>
                <a href="#" onclick="window.app.router('fitness')" class="hover:text-primary">ê±´ê°• ê´€ë¦¬</a>
                <a href="#" onclick="window.app.router('workout')" class="hover:text-primary">ìš´ë™ ì¼ì§€</a>
                <a href="#" onclick="window.app.router('challenge')" class="hover:text-primary text-purple-600 font-bold"><i class="fa-solid fa-scroll mr-1"></i>í€˜ìŠ¤íŠ¸</a>
                <a href="#" onclick="window.app.router('calorie')" class="hover:text-primary font-bold text-orange-500"><i class="fa-solid fa-fire mr-1"></i>ì¹¼ë¡œë¦¬</a>
                <a href="#" onclick="window.app.router('bookmarks')" class="hover:text-primary text-amber-500 font-bold"><i class="fa-solid fa-star mr-1"></i>ì¦ê²¨ì°¾ê¸°</a>
            </nav>

            <!-- Desktop Auth -->
            <div class="hidden md:flex items-center gap-3">
                <div id="nav-guest" class="flex gap-2">
                    <button onclick="window.app.auth.openModal('login')" class="text-slate-500 hover:text-primary font-medium px-3 py-2">ë¡œê·¸ì¸</button>
                    <button onclick="window.app.auth.openModal('signup')" class="bg-primary hover:bg-indigo-700 text-white font-medium px-4 py-2 rounded-lg transition">íšŒì›ê°€ì…</button>
                </div>
                <div id="nav-user" class="hidden flex items-center gap-3">
                    <div class="text-right cursor-pointer group" onclick="window.app.auth.openModal('profile')">
                        <div class="text-xs text-slate-400 group-hover:text-primary">ë‚´ ì •ë³´ ë³´ê¸°</div>
                        <div id="nav-username" class="text-sm font-bold text-slate-800 group-hover:text-primary transition">ì‚¬ìš©ìë‹˜</div>
                    </div>
                    <button onclick="window.app.auth.logout()" class="text-slate-400 hover:text-red-500 text-sm border border-slate-200 px-3 py-2 rounded-lg bg-white" title="ë¡œê·¸ì•„ì›ƒ">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Hamburger Button -->
            <button onclick="window.app.toggleMobileMenu()" class="md:hidden text-slate-600 hover:text-primary focus:outline-none p-2">
                <i class="fa-solid fa-bars text-2xl"></i>
            </button>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="bg-white border-t border-slate-100 shadow-lg md:hidden absolute w-full left-0 top-16 z-20">
            <div class="flex flex-col p-4 space-y-3 font-medium text-slate-600">
                <a href="#" onclick="window.app.router('home')" class="p-2 hover:bg-slate-50 rounded-lg"><i class="fa-solid fa-house w-6 text-center mr-2"></i>í™ˆ</a>
                <a href="#" onclick="window.app.router('map')" class="p-2 hover:bg-slate-50 rounded-lg"><i class="fa-solid fa-map-location-dot w-6 text-center mr-2"></i>ì‹œì„¤ ì°¾ê¸°</a>
                <a href="#" onclick="window.app.router('fitness')" class="p-2 hover:bg-slate-50 rounded-lg"><i class="fa-solid fa-heart-pulse w-6 text-center mr-2"></i>ê±´ê°• ê´€ë¦¬</a>
                <a href="#" onclick="window.app.router('workout')" class="p-2 hover:bg-slate-50 rounded-lg"><i class="fa-solid fa-calendar-check w-6 text-center mr-2"></i>ìš´ë™ ì¼ì§€</a>
                <a href="#" onclick="window.app.router('challenge')" class="p-2 hover:bg-slate-50 rounded-lg text-purple-600 font-bold"><i class="fa-solid fa-scroll w-6 text-center mr-2"></i>í€˜ìŠ¤íŠ¸</a>
                <a href="#" onclick="window.app.router('calorie')" class="p-2 hover:bg-slate-50 rounded-lg text-orange-500 font-bold"><i class="fa-solid fa-fire w-6 text-center mr-2"></i>ì¹¼ë¡œë¦¬ ê³„ì‚°</a>
                <a href="#" onclick="window.app.router('bookmarks')" class="p-2 hover:bg-slate-50 rounded-lg text-amber-500 font-bold"><i class="fa-solid fa-star w-6 text-center mr-2"></i>ì¦ê²¨ì°¾ê¸°</a>
                
                <hr class="border-slate-100 my-2">
                
                <!-- Mobile Auth Section -->
                <div id="mobile-nav-guest" class="grid grid-cols-2 gap-3">
                    <button onclick="window.app.auth.openModal('login')" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">ë¡œê·¸ì¸</button>
                    <button onclick="window.app.auth.openModal('signup')" class="bg-primary text-white py-3 rounded-xl font-bold">íšŒì›ê°€ì…</button>
                </div>
                <div id="mobile-nav-user" class="hidden flex-col gap-3">
                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg" onclick="window.app.auth.openModal('profile')">
                         <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 text-primary flex items-center justify-center font-bold"><i class="fa-regular fa-user"></i></div>
                            <div>
                                <div class="text-xs text-slate-400">ì•ˆë…•í•˜ì„¸ìš”</div>
                                <div id="mobile-nav-username" class="font-bold text-slate-800">ì‚¬ìš©ìë‹˜</div>
                            </div>
                         </div>
                         <i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i>
                    </div>
                    <button onclick="window.app.auth.logout()" class="w-full border border-slate-200 text-slate-500 py-2 rounded-lg text-sm hover:bg-red-50 hover:text-red-500 transition">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
    </header>

    <main class="min-h-screen">
        <!-- 1. HOME VIEW -->
        <div id="view-home" class="view-section p-4 md:p-8">
            <section class="max-w-4xl mx-auto text-center pt-10 md:pt-20 pb-10 md:pb-20">
                <span class="inline-block py-1 px-3 rounded-full bg-indigo-50 text-primary text-xs font-bold mb-4">Daily Quest Updated</span>
                <h1 class="text-3xl md:text-6xl font-extrabold tracking-tight mb-6 leading-tight">
                    ì˜¤ëŠ˜ì˜ ìš´ë™ í€˜ìŠ¤íŠ¸ë¥¼<br><span class="text-primary">ì™„ë£Œ</span>í•˜ì„¸ìš”
                </h1>
                <p class="text-base md:text-lg text-slate-500 mb-8 md:mb-10 max-w-xl mx-auto leading-relaxed px-4">
                    ë§¤ì¼ ë¬´ì‘ìœ„ë¡œ ì£¼ì–´ì§€ëŠ” ìƒˆë¡œìš´ ë¯¸ì…˜ì„ í´ë¦¬ì–´í•˜ê³ <br class="hidden md:inline"> ë ˆë²¨ì—…í•˜ëŠ” ì¬ë¯¸ë¥¼ ëŠê»´ë³´ì„¸ìš”.
                </p>
                <div class="flex flex-col md:flex-row justify-center gap-3 px-4 md:px-0">
                    <button onclick="window.app.router('challenge')" class="w-full md:w-auto bg-primary hover:bg-indigo-600 text-white font-bold py-3.5 px-8 rounded-xl shadow-lg shadow-indigo-200 transition transform hover:-translate-y-1">
                        ë¯¸ì…˜ í™•ì¸í•˜ê¸°
                    </button>
                    <button onclick="window.app.router('workout')" class="w-full md:w-auto bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 font-bold py-3.5 px-8 rounded-xl transition">
                        ìš´ë™ ì¼ì§€ ì“°ê¸°
                    </button>
                </div>
            </section>
            <section class="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 px-0 md:px-4 pb-20">
                <div onclick="window.app.router('map')" class="feature-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center cursor-pointer"><div class="w-12 h-12 bg-indigo-100 text-primary rounded-2xl flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-map-location-dot"></i></div><h3 class="font-bold text-lg mb-2">ì‹œì„¤ ì§€ë„</h3><p class="text-sm text-slate-500">ë‚´ ì£¼ë³€ ì‹œì„¤ì„ ì°¾ê³ <br>ë¦¬ë·°ë¥¼ ê³µìœ í•˜ì„¸ìš”.</p></div>
                <div onclick="window.app.router('fitness')" class="feature-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center cursor-pointer"><div class="w-12 h-12 bg-pink-100 text-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-heart-pulse"></i></div><h3 class="font-bold text-lg mb-2">ê±´ê°• ê´€ë¦¬</h3><p class="text-sm text-slate-500">BMI, ì‹ë‹¨, ìš´ë™ ì¶”ì²œì„<br>í•œ ê³³ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p></div>
                <div onclick="window.app.router('challenge')" class="feature-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center cursor-pointer"><div class="w-12 h-12 bg-purple-100 text-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-scroll"></i></div><h3 class="font-bold text-lg mb-2">ìš´ë™ í€˜ìŠ¤íŠ¸</h3><p class="text-sm text-slate-500">ë§¤ì¼ ìƒˆë¡œìš´ ë¯¸ì…˜ì„<br>í´ë¦¬ì–´í•˜ê³  ì„±ì¥í•˜ì„¸ìš”.</p></div>
                <div onclick="window.app.router('workout')" class="feature-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center cursor-pointer"><div class="w-12 h-12 bg-emerald-100 text-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-calendar-check"></i></div><h3 class="font-bold text-lg mb-2">ìš´ë™ ì¼ì§€</h3><p class="text-sm text-slate-500">ì–´ë””ì„œ ë¬´ì—‡ì„ í–ˆëŠ”ì§€<br>ìƒì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”.</p></div>
            </section>
        </div>

        <!-- 2. MAP VIEW -->
        <div id="view-map" class="view-section hidden p-4 md:p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-4 md:mb-6 gap-2">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">ì‹œì„¤ ì°¾ê¸° & ë¦¬ë·°</h2><p class="text-slate-500 text-xs md:text-sm">ë¦¬ë·°ë¥¼ 50ì ì´ìƒ ì‘ì„±í•˜ë©´ ë³´ë„ˆìŠ¤ ê²½í—˜ì¹˜ë¥¼ íšë“í•©ë‹ˆë‹¤!</p></div>
                    <!-- ê²€ìƒ‰ í•„í„° ì˜ì—­ ìˆ˜ì • -->
                    <div class="w-full md:w-auto flex flex-col md:flex-row gap-2">
                        <div class="grid grid-cols-2 gap-2 md:flex">
                            <select id="province-filter" class="bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[100px] focus:border-primary outline-none"></select>
                            <select id="district-filter" class="bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[100px] focus:border-primary outline-none" disabled><option value="">ì‹œ/ë„ ì„ íƒ</option></select>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ (ëª¨ë°”ì¼ì—ì„œëŠ” ê³µê°„ ì ˆì•½ì„ ìœ„í•´ ìˆ¨ê¸°ê±°ë‚˜ ì¤„ì¼ ìˆ˜ ìˆìŒ, ì—¬ê¸°ì„œëŠ” ìœ ì§€í•˜ë˜ flex-1 ì ìš©) -->
                            <select id="type-filter" class="bg-white border border-slate-300 text-sm rounded-lg p-2.5 w-24 md:w-auto focus:border-primary outline-none"></select>
                            <!-- ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ ì…ë ¥ì°½ ì¶”ê°€ -->
                            <input type="text" id="map-keyword-input" class="flex-1 bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[150px] focus:border-primary outline-none" placeholder="ì‹œì„¤ëª…, ì¢…ëª© (ì˜ˆ: í…Œë‹ˆìŠ¤)" onkeypress="if(event.key === 'Enter') window.app.map.filter()">
                            <button onclick="window.app.map.filter()" class="bg-slate-800 text-white text-sm font-medium px-4 py-2.5 rounded-lg hover:bg-slate-900 whitespace-nowrap"><i class="fa-solid fa-magnifying-glass md:hidden"></i><span class="hidden md:inline">ê²€ìƒ‰</span></button>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col lg:flex-row gap-4 md:gap-6">
                    <div id="map" class="w-full lg:w-2/3 shadow-lg border border-slate-200 relative"></div>
                    <div class="w-full lg:w-1/3 flex flex-col gap-4 h-auto md:h-[70vh]">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[300px] md:h-1/2 overflow-hidden">
                            <div class="p-3 md:p-4 border-b border-slate-100 bg-slate-50"><h3 class="font-bold text-sm">ê²€ìƒ‰ ê²°ê³¼</h3></div>
                            <ul id="facility-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                                <li class="text-center text-xs text-slate-400 py-10">ì§€ë„ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</li>
                            </ul>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[300px] md:h-1/2 overflow-hidden">
                            <div class="p-3 md:p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <h3 class="font-bold text-sm">ë¦¬ë·° <span id="review-target-name" class="text-primary font-normal ml-1 truncate max-w-[100px] inline-block align-bottom"></span></h3>
                                <button onclick="window.app.reviews.write()" class="text-xs bg-slate-800 text-white px-2 py-1 rounded hover:bg-slate-700">ì‘ì„±í•˜ê¸°</button>
                            </div>
                            <ul id="review-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                                <li class="text-center text-xs text-slate-400 py-10">ì‹œì„¤ì„ ì„ íƒí•˜ë©´ ë¦¬ë·°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. FITNESS VIEW -->
        <div id="view-fitness" class="view-section hidden p-4 md:p-8">
             <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-100 mt-2 md:mt-6 overflow-hidden min-h-[600px]">
                <div class="flex border-b border-slate-100 overflow-x-auto">
                    <button onclick="window.app.tools.switchFitnessTab('bmi')" id="tab-btn-bmi" class="flex-1 py-3 md:py-4 px-2 whitespace-nowrap text-center text-xs md:text-sm transition tab-active">BMI ë¶„ì„</button>
                    <button onclick="window.app.tools.switchFitnessTab('diet')" id="tab-btn-diet" class="flex-1 py-3 md:py-4 px-2 whitespace-nowrap text-center text-xs md:text-sm transition tab-inactive">ìƒì„¸ ì‹ë‹¨</button>
                    <button onclick="window.app.tools.switchFitnessTab('guide')" id="tab-btn-guide" class="flex-1 py-3 md:py-4 px-2 whitespace-nowrap text-center text-xs md:text-sm transition tab-inactive">ìš´ë™ ê°€ì´ë“œ</button>
                </div>
                
                <div id="content-bmi" class="p-4 md:p-8 animate-fade-in">
                    <h2 class="text-xl md:text-2xl font-bold text-center mb-6"><i class="fa-solid fa-heart-pulse text-pink-500 mr-2"></i>ì¢…í•© ì‹ ì²´ ì •ë°€ ì§„ë‹¨</h2>
                    <div class="max-w-md mx-auto">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">ì‹ ì¥ (cm)</label><input type="number" id="bmi-height" class="w-full border rounded-lg p-3 focus:border-pink-500 outline-none bg-slate-50" placeholder="175"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">ì²´ì¤‘ (kg)</label><input type="number" id="bmi-weight" class="w-full border rounded-lg p-3 focus:border-pink-500 outline-none bg-slate-50" placeholder="70"></div>
                        </div>
                        <hr class="border-slate-200 my-6 border-dashed">
                        <div class="mb-6">
                            <h4 class="font-bold text-sm text-slate-700 mb-3 flex items-center"><i class="fa-solid fa-utensils mr-2 text-green-500"></i>ì˜¤ëŠ˜ì˜ í™œë™ ë° ì„­ì·¨</h4>
                            <div class="space-y-4">
                                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                    <label class="block text-xs text-slate-500 mb-2 font-bold">ğŸ½ï¸ ì˜¤ëŠ˜ ê°€ì¥ ë§ì´ ë¨¹ì€ ì˜ì–‘ì†ŒëŠ”?</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <label class="cursor-pointer"><input type="radio" name="bmi-macro" value="carbs" class="peer sr-only"><div class="text-xs font-medium text-center py-2 rounded border border-slate-200 bg-white text-slate-600 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-600 transition">íƒ„ìˆ˜í™”ë¬¼</div></label>
                                        <label class="cursor-pointer"><input type="radio" name="bmi-macro" value="protein" class="peer sr-only"><div class="text-xs font-medium text-center py-2 rounded border border-slate-200 bg-white text-slate-600 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-600 transition">ë‹¨ë°±ì§ˆ</div></label>
                                        <label class="cursor-pointer"><input type="radio" name="bmi-macro" value="fat" class="peer sr-only"><div class="text-xs font-medium text-center py-2 rounded border border-slate-200 bg-white text-slate-600 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-600 transition">ì§€ë°©</div></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="border-slate-200 my-6 border-dashed">
                        <div class="mb-6">
                            <h4 class="font-bold text-sm text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-clipboard-question mr-2 text-pink-400"></i>ìƒì„¸ ì»¨ë””ì…˜ ì²´í¬</h4>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-xs text-slate-500 mb-2 font-bold">ğŸ”‹ í˜„ì¬ í”¼ë¡œë„ (1~10)</label>
                                    <div class="relative mb-1">
                                        <input type="range" id="bmi-fatigue" min="1" max="10" value="5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-500 z-10 relative" oninput="document.getElementById('fatigue-val').textContent = this.value">
                                    </div>
                                    <div class="flex justify-between items-center text-[10px] font-bold">
                                        <span class="text-blue-500">ìŒ©ìŒ©í•¨</span>
                                        <span class="text-pink-500">Level <span id="fatigue-val">5</span></span>
                                        <span class="text-red-500">ë…¹ì´ˆë¨</span>
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                    <label class="block text-xs text-slate-500 mb-3 font-bold">ğŸ©¹ ë¶ˆí¸í•˜ê±°ë‚˜ ì•„í”ˆ ê³³ (ë‹¤ì¤‘ ì„ íƒ)</label>
                                    <div class="grid grid-cols-3 gap-2" id="bmi-pain-area">
                                        <label class="cursor-pointer"><input type="checkbox" value="neck" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ëª©</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="shoulder" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ì–´ê¹¨</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="elbow" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">íŒ”ê¿ˆì¹˜</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="wrist" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ì†ëª©</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="back" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ë“±/í—ˆë¦¬</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="pelvis" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ê³¨ë°˜</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="knee" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ë¬´ë¦</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="ankle" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ë°œëª©</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" value="muscle" class="peer sr-only"><div class="text-xs text-center border border-slate-200 bg-white py-2 rounded peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-600 transition">ì „ì‹ ê·¼ìœ¡í†µ</div></label>
                                    </div>
                                    <div class="relative mt-2">
                                        <input type="text" id="bmi-pain-custom" class="w-full border rounded-lg p-2.5 text-xs focus:border-pink-500 outline-none pl-9 bg-white" placeholder="ê¸°íƒ€ ì•„í”ˆ ë¶€ìœ„ (ì˜ˆ: ì˜¤ë¥¸ìª½ ì†ê°€ë½)">
                                        <i class="fa-solid fa-pen absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.app.tools.calculateBMI()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl transition shadow-lg flex justify-center items-center gap-2"><i class="fa-solid fa-notes-medical"></i> ì •ë°€ ë¶„ì„ ê²°ê³¼ í™•ì¸</button>
                    </div>
                    <div id="bmi-result" class="mt-8 hidden">
                        <div class="bg-white border-2 border-slate-800 rounded-2xl shadow-lg overflow-hidden">
                            <div class="p-6 border-b border-slate-100 bg-slate-50">
                                <div class="flex justify-between items-end mb-2">
                                    <div><div class="text-xs font-bold text-slate-500 uppercase tracking-wide">BMI Score</div><div class="text-4xl font-extrabold text-slate-800" id="bmi-value">0</div></div>
                                    <div class="text-right"><div class="text-lg font-bold px-3 py-1 rounded-full bg-white border border-slate-200" id="bmi-status">-</div></div>
                                </div>
                                <p id="bmi-desc" class="text-sm text-slate-600 leading-relaxed"></p>
                            </div>
                            <div class="p-6 space-y-5">
                                <div><strong class="text-xs font-bold text-green-600 block mb-2"><i class="fa-solid fa-scale-balanced mr-1"></i>ìƒí™œ ìŠµê´€ ë¶„ì„</strong><p id="bmi-advice-balance" class="text-sm text-slate-700 leading-relaxed bg-green-50 p-3 rounded-lg border border-green-100"></p></div>
                                <div><strong class="text-xs font-bold text-blue-600 block mb-2"><i class="fa-solid fa-battery-half mr-1"></i>ì»¨ë””ì…˜ ê°€ì´ë“œ</strong><p id="bmi-advice-fatigue" class="text-sm text-slate-700 leading-relaxed bg-blue-50 p-3 rounded-lg border border-blue-100"></p></div>
                                <div id="bmi-pain-advice-box" class="hidden"><strong class="text-xs font-bold text-red-500 block mb-2"><i class="fa-solid fa-user-nurse mr-1"></i>ë¶€ìœ„ë³„ ê´€ë¦¬ íŒ & ì¶”ì²œ ìŒì‹</strong><div id="bmi-advice-pain" class="text-sm text-slate-700 leading-relaxed bg-red-50 p-3 rounded-lg border border-red-100 space-y-2"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="content-diet" class="hidden p-4 md:p-8 animate-fade-in">
                     <h2 class="text-xl md:text-2xl font-bold text-center mb-6"><i class="fa-solid fa-utensils text-green-500 mr-2"></i>ë§ì¶¤í˜• ì˜ì–‘ ì„¤ê³„</h2>
                    <div class="space-y-4 max-w-md mx-auto">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">ì„±ë³„</label><select id="diet-gender" class="w-full border rounded-lg p-2.5 bg-white"><option value="m">ë‚¨ì„±</option><option value="f">ì—¬ì„±</option></select></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">ë‚˜ì´</label><input type="number" id="diet-age" class="w-full border rounded-lg p-2.5" placeholder="25"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">í‚¤ (cm)</label><input type="number" id="diet-height" class="w-full border rounded-lg p-2.5" placeholder="175"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">ëª¸ë¬´ê²Œ (kg)</label><input type="number" id="diet-weight" class="w-full border rounded-lg p-2.5" placeholder="70"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">í™œë™ëŸ‰</label>
                            <select id="diet-activity" class="w-full border rounded-lg p-2.5 text-sm bg-white"><option value="1.2">ì•‰ì•„ì„œ ì¼í•¨ (ìš´ë™ ê±°ì˜ ì•ˆ í•¨)</option><option value="1.375">ê°€ë²¼ìš´ í™œë™ (ì£¼ 1~3íšŒ ìš´ë™)</option><option value="1.55">ë³´í†µ í™œë™ (ì£¼ 3~5íšŒ ìš´ë™)</option><option value="1.725">ë§ì€ í™œë™ (ì£¼ 6~7íšŒ ìš´ë™)</option><option value="1.9">ë§¤ìš° ë§ì€ í™œë™ (ì„ ìˆ˜ê¸‰)</option></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ëª©í‘œ</label>
                            <select id="diet-goal" class="w-full border rounded-lg p-2.5 font-bold text-primary bg-white"><option value="lose">ì²´ì§€ë°© ê°ëŸ‰ (ë‹¤ì´ì–´íŠ¸)</option><option value="maintain">í˜„ì¬ ì²´ì¤‘ ìœ ì§€</option><option value="gain">ê·¼ìœ¡ëŸ‰ ì¦ê°€ (ë²Œí¬ì—…)</option></select>
                        </div>
                        <button onclick="window.app.tools.calculateDiet()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition mt-2 shadow-md shadow-green-200">ì‹ë‹¨ ë¶„ì„ ë° ì¶”ì²œ ë°›ê¸°</button>
                    </div>
                    <div id="diet-result" class="hidden mt-8 pt-6 border-t border-slate-100">
                        <div class="text-center mb-6"><div class="text-sm text-slate-500">í•˜ë£¨ ëª©í‘œ ì„­ì·¨ëŸ‰</div><div class="text-4xl font-extrabold text-slate-800 my-1"><span id="diet-calories" class="text-green-600">0</span> kcal</div></div>
                        <div class="grid grid-cols-3 gap-3 text-center mb-6">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><div class="text-xs text-slate-400 mb-1">íƒ„ìˆ˜í™”ë¬¼</div><div class="font-bold text-lg text-slate-700"><span id="diet-carbs">0</span>g</div></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><div class="text-xs text-slate-400 mb-1">ë‹¨ë°±ì§ˆ</div><div class="font-bold text-lg text-slate-700"><span id="diet-protein">0</span>g</div></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><div class="text-xs text-slate-400 mb-1">ì§€ë°©</div><div class="font-bold text-lg text-slate-700"><span id="diet-fat">0</span>g</div></div>
                        </div>
                        <div class="bg-green-50 p-5 rounded-xl border border-green-100"><h4 class="font-bold text-green-800 text-sm mb-3"><i class="fa-solid fa-carrot mr-2"></i>ì¶”ì²œ ì‹í’ˆ ê°€ì´ë“œ</h4><ul id="diet-food-list" class="text-xs text-green-800 space-y-2 leading-relaxed list-disc list-inside"></ul><div class="mt-4 pt-3 border-t border-green-200"><p id="diet-tip" class="text-xs text-green-700 font-medium"></p></div></div>
                    </div>
                </div>
                <div id="content-guide" class="hidden p-4 md:p-8 animate-fade-in">
                    <h2 class="text-xl md:text-2xl font-bold text-center mb-6">ì „ë¬¸ ìš´ë™ ê°€ì´ë“œ</h2>
                    <div class="flex flex-wrap justify-center gap-2 mb-6" id="guide-buttons"></div>
                    <div id="guide-result" class="hidden"><h3 id="guide-target-title" class="text-lg font-bold text-slate-800 mb-3 border-l-4 border-blue-500 pl-3"></h3><div id="guide-list" class="space-y-3 h-[400px] overflow-y-auto pr-2 custom-scrollbar"></div></div>
                    <div id="guide-placeholder" class="text-center text-slate-400 py-10"><div class="text-4xl mb-2 animate-bounce"><i class="fa-regular fa-hand-pointer"></i></div><p>ì›í•˜ëŠ” ìš´ë™ ë¶€ìœ„ë¥¼ ì„ íƒí•˜ë©´<br>ì¶”ì²œ ë£¨í‹´ì´ í‘œì‹œë©ë‹ˆë‹¤.</p></div>
                </div>
            </div>
        </div>

        <!-- 4. WORKOUT VIEW -->
        <div id="view-workout" class="view-section hidden p-4 md:p-8">
             <div class="max-w-6xl mx-auto">
                <div id="workout-guest-msg" class="hidden text-center py-20 bg-white rounded-2xl shadow-sm border border-slate-200 mx-auto max-w-md">
                    <div class="text-6xl mb-4">ğŸ”’</div><h2 class="text-2xl font-bold mb-2">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤</h2><p class="text-slate-500 mb-6">ë‚˜ë§Œì˜ ìš´ë™ ê¸°ë¡ì„ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p><button onclick="window.app.auth.openModal('login')" class="bg-primary hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl w-full md:w-auto">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</button>
                </div>
                <div id="workout-content" class="hidden flex flex-col lg:flex-row gap-6">
                    <div class="w-full lg:w-3/5 bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="window.app.calendar.changeMonth(-1)" class="w-8 h-8 rounded-full hover:bg-slate-100"><i class="fa-solid fa-chevron-left"></i></button><h2 id="cal-title" class="text-xl font-bold text-slate-800"></h2><button onclick="window.app.calendar.changeMonth(1)" class="w-8 h-8 rounded-full hover:bg-slate-100"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2 text-center text-xs md:text-sm font-medium text-slate-400"><div class="text-red-400">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-blue-400">í† </div></div>
                        <div id="cal-grid" class="grid grid-cols-7 gap-1 md:gap-2"></div>
                    </div>
                    <div class="w-full lg:w-2/5 flex flex-col h-auto md:h-[650px] bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden mt-4 lg:mt-0">
                        <div class="bg-primary p-4 text-white flex justify-between items-end"><div><h3 id="cal-selected-date" class="font-bold text-2xl">ë‚ ì§œ ì„ íƒ</h3><p class="text-indigo-200 text-xs mt-1">ì˜¤ëŠ˜ì˜ ìš´ë™ì„ ìƒì„¸í•˜ê²Œ ê¸°ë¡í•˜ì„¸ìš”</p></div><div class="text-4xl opacity-20"><i class="fa-solid fa-pen-to-square"></i></div></div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 min-h-[200px]" id="workout-list"><div class="text-center text-slate-400 text-sm py-10"><i class="fa-regular fa-calendar-xmark text-2xl mb-2"></i><br>ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
                        <div class="p-4 border-t border-slate-200 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10">
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input type="text" id="wo-name" class="flex-1 border-b-2 border-slate-200 p-2 text-base font-bold focus:border-primary focus:outline-none transition bg-transparent" placeholder="ìš´ë™ (ì˜ˆ: ë²¤ì¹˜í”„ë ˆìŠ¤)">
                                    <input type="text" id="wo-place" class="w-1/3 border-b-2 border-slate-200 p-2 text-xs text-slate-600 focus:border-primary focus:outline-none transition bg-transparent" placeholder="ì¥ì†Œ (ì˜ˆ: í—¬ìŠ¤ì¥)">
                                </div>
                                <div class="grid grid-cols-4 gap-2">
                                    <div class="bg-slate-50 rounded-lg p-2 border border-slate-100"><label class="block text-[10px] text-slate-400 font-bold mb-1">ë¬´ê²Œ(kg)</label><input type="number" id="wo-weight" class="w-full bg-transparent text-sm font-bold text-center focus:outline-none" placeholder="0"></div>
                                    <div class="bg-slate-50 rounded-lg p-2 border border-slate-100"><label class="block text-[10px] text-slate-400 font-bold mb-1">ì„¸íŠ¸</label><input type="number" id="wo-sets" class="w-full bg-transparent text-sm font-bold text-center focus:outline-none" placeholder="0"></div>
                                    <div class="bg-slate-50 rounded-lg p-2 border border-slate-100"><label class="block text-[10px] text-slate-400 font-bold mb-1">íšŸìˆ˜</label><input type="number" id="wo-reps" class="w-full bg-transparent text-sm font-bold text-center focus:outline-none" placeholder="0"></div>
                                    <div class="bg-slate-50 rounded-lg p-2 border border-slate-100"><label class="block text-[10px] text-slate-400 font-bold mb-1">ì‹œê°„(ë¶„)</label><input type="number" id="wo-time" class="w-full bg-transparent text-sm font-bold text-center focus:outline-none" placeholder="0"></div>
                                </div>
                                <button onclick="window.app.calendar.add()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-700 transition shadow-lg flex justify-center items-center gap-2"><i class="fa-solid fa-plus"></i> ê¸°ë¡ ì¶”ê°€</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. CHALLENGE VIEW -->
        <div id="view-challenge" class="view-section hidden p-4 md:p-8">
            <div class="max-w-5xl mx-auto">
                <div class="mb-8 flex justify-between items-end">
                     <div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800">í€˜ìŠ¤íŠ¸ ë³´ë“œ</h2>
                        <p class="text-slate-500 mt-1 text-sm md:text-base">ë§¤ì¼ ìƒˆë¡œìš´ ë¯¸ì…˜ì´ ë„ì°©í•©ë‹ˆë‹¤!</p>
                     </div>
                     <div class="text-right">
                        <div class="text-xs text-slate-400 font-bold uppercase">Total XP</div>
                        <div class="text-xl md:text-2xl font-black text-purple-600" id="total-xp-display">0 XP</div>
                     </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    <!-- Daily Missions -->
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center"><i class="fa-solid fa-sun text-orange-500 mr-2"></i>ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h3>
                            <div class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-bold">00ì‹œ ì´ˆê¸°í™”</div>
                        </div>
                        <div class="space-y-3" id="daily-quest-list"></div>
                        <div class="mt-6">
                            <div class="flex justify-between text-xs mb-1 font-bold text-slate-500"><span>ë‹¬ì„±ë¥ </span><span id="daily-progress-text">0%</span></div>
                            <div class="w-full bg-slate-100 rounded-full h-2.5"><div id="daily-progress-bar" class="bg-orange-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                    </div>

                    <!-- Weekly Missions -->
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center"><i class="fa-solid fa-calendar-week text-blue-500 mr-2"></i>ì£¼ê°„ ë¯¸ì…˜</h3>
                            <div class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">ì›”ìš”ì¼ ì´ˆê¸°í™”</div>
                        </div>
                        <div class="space-y-3" id="weekly-quest-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. CALORIE VIEW -->
        <div id="view-calorie" class="view-section hidden p-4 md:p-8">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-6 md:mb-10">
                    <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800">ì¹¼ë¡œë¦¬ ë¶„ì„ ì„¼í„°</h2>
                    <p class="text-slate-500 mt-2 text-sm">ìš´ë™ ì†Œëª¨ ì¹¼ë¡œë¦¬ì™€ ì¼ì¼ ëŒ€ì‚¬ëŸ‰ì„ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="flex justify-center mb-6 md:mb-8">
                    <div class="bg-slate-100 p-1 rounded-xl inline-flex w-full md:w-auto">
                        <button onclick="window.app.tools.switchCalTab('burn')" id="cal-tab-burn" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-bold transition bg-white text-slate-800 shadow-sm">ìš´ë™ ì†Œëª¨ëŸ‰</button>
                        <button onclick="window.app.tools.switchCalTab('daily')" id="cal-tab-daily" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 transition">ì¼ì¼ ëŒ€ì‚¬ëŸ‰</button>
                    </div>
                </div>
                <div id="cal-content-burn" class="animate-fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-slate-100">
                            <h3 class="font-bold text-lg mb-4 flex items-center"><i class="fa-solid fa-fire-flame-curved text-orange-500 mr-2"></i>ìš´ë™ ì •ë³´ ì…ë ¥</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">ì²´ì¤‘ (kg)</label>
                                    <input type="number" id="burn-weight" class="w-full border rounded-lg p-3 focus:border-orange-500 outline-none" placeholder="70">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">ìš´ë™ ì¢…ëª©</label>
                                    <select id="burn-activity" class="w-full border rounded-lg p-3 text-sm focus:border-orange-500 outline-none bg-white">
                                        <option value="0">ìš´ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                        <optgroup label="ìœ ì‚°ì†Œ (Cardio)">
                                            <option value="3.5">ê±·ê¸° (ì‚°ì±…, 4km/h)</option>
                                            <option value="4.5">ë¹ ë¥´ê²Œ ê±·ê¸° (6km/h)</option>
                                            <option value="8.0">ëŸ¬ë‹ (ê°€ë³ê²Œ, 8km/h)</option>
                                            <option value="11.5">ëŸ¬ë‹ (ë¹ ë¥´ê²Œ, 11km/h)</option>
                                            <option value="16.0">ì „ë ¥ ì§ˆì£¼</option>
                                            <option value="7.0">ë“±ì‚° (ì¼ë°˜)</option>
                                            <option value="4.0">ìì „ê±° (ê°€ë³ê²Œ, &lt;16km/h)</option>
                                            <option value="8.0">ìì „ê±° (ë³´í†µ, 20km/h)</option>
                                            <option value="7.0">ìˆ˜ì˜ (ê°€ë³ê²Œ)</option>
                                            <option value="10.0">ìˆ˜ì˜ (ê²©ë ¬í•˜ê²Œ)</option>
                                            <option value="12.3">ì¤„ë„˜ê¸° (ë¹ ë¥´ê²Œ)</option>
                                        </optgroup>
                                        <optgroup label="ê·¼ë ¥ & í”¼íŠ¸ë‹ˆìŠ¤">
                                            <option value="3.5">ì›¨ì´íŠ¸ íŠ¸ë ˆì´ë‹ (ê°€ë³ê²Œ)</option>
                                            <option value="6.0">ì›¨ì´íŠ¸ íŠ¸ë ˆì´ë‹ (ê³ ê°•ë„)</option>
                                            <option value="8.0">ì„œí‚· íŠ¸ë ˆì´ë‹</option>
                                            <option value="6.0">í¬ë¡œìŠ¤í•</option>
                                            <option value="2.5">ìš”ê°€ (í•˜íƒ€)</option>
                                            <option value="4.0">ìš”ê°€ (íŒŒì›Œ)</option>
                                            <option value="3.0">í•„ë¼í…ŒìŠ¤</option>
                                        </optgroup>
                                        <optgroup label="ìŠ¤í¬ì¸ ">
                                            <option value="7.0">ì¶•êµ¬ (ì¼ë°˜ ê²½ê¸°)</option>
                                            <option value="8.0">ë†êµ¬ (ê²Œì„)</option>
                                            <option value="7.3">í…Œë‹ˆìŠ¤</option>
                                            <option value="4.5">ê³¨í”„ (ì¹´íŠ¸ ì´ìš©)</option>
                                            <option value="5.5">ë°°ë“œë¯¼í„´</option>
                                            <option value="10.0">ë³µì‹± (ìŠ¤íŒŒë§)</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">ìš´ë™ ì‹œê°„ (ë¶„)</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="burn-time" class="flex-1 border rounded-lg p-3 focus:border-orange-500 outline-none" placeholder="60">
                                        <div class="flex gap-1">
                                            <button onclick="document.getElementById('burn-time').value=30" class="bg-slate-100 text-xs px-2 py-1 rounded hover:bg-slate-200">30ë¶„</button>
                                            <button onclick="document.getElementById('burn-time').value=60" class="bg-slate-100 text-xs px-2 py-1 rounded hover:bg-slate-200">60ë¶„</button>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="window.app.tools.calculateBurn()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-orange-200 mt-2">ì¹¼ë¡œë¦¬ ê³„ì‚°í•˜ê¸°</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 flex flex-col justify-center items-center text-center relative overflow-hidden min-h-[300px]">
                            <div id="burn-result-placeholder" class="text-slate-400">
                                <i class="fa-solid fa-calculator text-4xl mb-3 opacity-30"></i>
                                <p class="text-sm">ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´<br>ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                            <div id="burn-result-content" class="hidden w-full">
                                 <div class="text-sm text-slate-500 font-bold uppercase tracking-wider mb-1">Total Energy Burned</div>
                                 <div class="text-5xl font-black text-orange-600 mb-2"><span id="burn-total">0</span> <span class="text-2xl text-slate-600 font-bold">kcal</span></div>
                                 <div class="inline-block bg-orange-50 text-orange-600 px-3 py-1 rounded-full text-xs font-bold border border-orange-100 mb-6">
                                    <i class="fa-regular fa-clock mr-1"></i> ì‹œê°„ë‹¹ ì•½ <span id="burn-hourly">0</span> kcal ì†Œëª¨
                                 </div>
                                 <div class="w-full bg-slate-50 rounded-xl p-4 border border-slate-100 text-left">
                                    <h4 class="text-xs font-bold text-slate-500 mb-3">ìŒì‹ í™˜ì‚° (ëŒ€ëµì )</h4>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div class="bg-white p-2 rounded-lg border border-slate-100 text-center">
                                            <div class="text-xl mb-1">ğŸš</div>
                                            <div class="text-[10px] text-slate-500">ê³µê¸°ë°¥</div>
                                            <div class="font-bold text-slate-700"><span id="food-rice">0.0</span>ê³µê¸°</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg border border-slate-100 text-center">
                                            <div class="text-xl mb-1">ğŸ”</div>
                                            <div class="text-[10px] text-slate-500">í–„ë²„ê±°</div>
                                            <div class="font-bold text-slate-700"><span id="food-burger">0.0</span>ê°œ</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg border border-slate-100 text-center">
                                            <div class="text-xl mb-1">ğŸ•</div>
                                            <div class="text-[10px] text-slate-500">í”¼ì</div>
                                            <div class="font-bold text-slate-700"><span id="food-pizza">0.0</span>ì¡°ê°</div>
                                        </div>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="cal-content-daily" class="hidden animate-fade-in">
                     <div class="bg-white p-4 md:p-8 rounded-2xl shadow-lg border border-slate-100 max-w-2xl mx-auto">
                        <h3 class="font-bold text-lg mb-6 flex items-center justify-center"><i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>ì¼ì¼ ì—ë„ˆì§€ ìš”êµ¬ëŸ‰ (TDEE)</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">ì„±ë³„</label><select id="tdee-gender" class="w-full border rounded-lg p-3 bg-white"><option value="m">ë‚¨ì„±</option><option value="f">ì—¬ì„±</option></select></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">ë‚˜ì´</label><input type="number" id="tdee-age" class="w-full border rounded-lg p-3" placeholder="25"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">ì‹ ì¥ (cm)</label><input type="number" id="tdee-height" class="w-full border rounded-lg p-3" placeholder="175"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">ì²´ì¤‘ (kg)</label><input type="number" id="tdee-weight" class="w-full border rounded-lg p-3" placeholder="70"></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">í™œë™ ìˆ˜ì¤€</label>
                                <select id="tdee-activity" class="w-full border rounded-lg p-3 text-sm bg-white">
                                    <option value="1.2">ì¢Œì‹ ìƒí™œ (ìš´ë™ ì•ˆ í•¨)</option>
                                    <option value="1.375">ê°€ë²¼ìš´ í™œë™ (ì£¼ 1-3íšŒ ìš´ë™)</option>
                                    <option value="1.55">ë³´í†µ í™œë™ (ì£¼ 3-5íšŒ ìš´ë™)</option>
                                    <option value="1.725">ë§¤ìš° í™œë™ì  (ì£¼ 6-7íšŒ ìš´ë™)</option>
                                    <option value="1.9">ì´ˆê³ ê°•ë„ (ì„ ìˆ˜ê¸‰ í™œë™)</option>
                                </select>
                            </div>
                            <button onclick="window.app.tools.calculateTDEE()" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-xl hover:bg-slate-900 transition shadow-lg mt-2">ë¶„ì„í•˜ê¸°</button>
                        </div>
                        <div id="tdee-result" class="hidden mt-8 pt-8 border-t border-slate-100 text-center">
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-4 rounded-xl">
                                    <div class="text-xs text-slate-500 mb-1">ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ (BMR)</div>
                                    <div class="text-xl font-bold text-slate-800"><span id="val-bmr">0</span> kcal</div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                    <div class="text-xs text-blue-500 mb-1">ìœ ì§€ ì¹¼ë¡œë¦¬ (TDEE)</div>
                                    <div class="text-xl font-bold text-blue-600"><span id="val-tdee">0</span> kcal</div>
                                </div>
                            </div>
                            <h4 class="text-sm font-bold text-slate-700 mb-3">ëª©í‘œë³„ ê¶Œì¥ ì„­ì·¨ëŸ‰</h4>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div class="p-3 rounded-lg border border-green-100 bg-green-50">
                                    <div class="text-green-600 font-bold mb-1">ë‹¤ì´ì–´íŠ¸</div>
                                    <div id="val-cut" class="text-xs md:text-sm">0</div>
                                </div>
                                <div class="p-3 rounded-lg border border-slate-200 bg-white">
                                    <div class="text-slate-600 font-bold mb-1">ìœ ì§€</div>
                                    <div id="val-maintain" class="text-xs md:text-sm">0</div>
                                </div>
                                <div class="p-3 rounded-lg border border-orange-100 bg-orange-50">
                                    <div class="text-orange-600 font-bold mb-1">ë²Œí¬ì—…</div>
                                    <div id="val-bulk" class="text-xs md:text-sm">0</div>
                                </div>
                            </div>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <!-- 8. BOOKMARKS VIEW -->
        <div id="view-bookmarks" class="view-section hidden p-4 md:p-8">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-4 md:mb-6 flex items-center"><i class="fa-solid fa-star text-amber-500 mr-2"></i>ì¦ê²¨ì°¾ê¸° ëª©ë¡</h2>
                <div id="bookmark-list" class="grid grid-cols-1 gap-4"><div class="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl"><i class="fa-regular fa-star text-4xl mb-3 opacity-50"></i><br>ì•„ì§ ì¦ê²¨ì°¾ê¸°í•œ ì‹œì„¤ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="auth-modal" class="fixed inset-0 z-50 hidden opacity-0 pointer-events-none modal">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="window.app.auth.closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] md:w-full max-w-sm rounded-2xl shadow-2xl p-6 overflow-hidden">
            <div id="auth-tabs" class="flex justify-center mb-6 border-b border-slate-100"><button onclick="window.app.auth.switchTab('login')" id="tab-login" class="flex-1 py-2 text-primary border-b-2 border-primary font-bold">ë¡œê·¸ì¸</button><button onclick="window.app.auth.switchTab('signup')" id="tab-signup" class="flex-1 py-2 text-slate-400 font-medium">íšŒì›ê°€ì…</button></div>
            <div id="profile-title" class="hidden text-center mb-6"><h3 class="text-xl font-bold text-slate-800">ë‚´ ì •ë³´</h3><p class="text-xs text-slate-400 mt-1">ê³„ì • ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p></div>
            <div id="form-container" class="space-y-4">
                <div id="field-name" class="hidden"><label class="text-xs font-bold text-slate-500">ë‹‰ë„¤ì„</label><input type="text" id="auth-name" class="w-full border rounded-lg p-2.5 focus:border-primary outline-none" placeholder="í™ê¸¸ë™"></div>
                <div><label class="text-xs font-bold text-slate-500">ì´ë©”ì¼</label><input type="email" id="auth-email" class="w-full border rounded-lg p-2.5 focus:border-primary outline-none" placeholder="hello@example.com"></div>
                <div><label class="text-xs font-bold text-slate-500">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="auth-pw" class="w-full border rounded-lg p-2.5 focus:border-primary outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
                <button onclick="window.app.auth.submit()" id="auth-submit-btn" class="w-full bg-slate-300 text-white font-bold py-3 rounded-xl cursor-not-allowed transition flex justify-center items-center" disabled><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>ì„œë²„ ì—°ê²° ì¤‘...</button>
            </div>
            <div id="profile-container" class="hidden space-y-6">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100 text-center relative">
                    <div class="relative w-24 h-24 mx-auto mb-4 group cursor-pointer" onclick="document.getElementById('profile-upload').click()">
                        <img id="profile-img" src="" class="w-full h-full rounded-full object-cover border-4 border-white shadow-md hidden">
                        <div id="profile-placeholder" class="w-full h-full bg-indigo-100 text-primary rounded-full flex items-center justify-center text-4xl border-4 border-white shadow-md"><i class="fa-regular fa-user"></i></div>
                        <div class="absolute bottom-0 right-0 w-8 h-8 bg-slate-800 text-white rounded-full flex items-center justify-center text-sm border-2 border-white shadow-lg transition transform group-hover:scale-110 group-hover:bg-primary"><i class="fa-solid fa-camera"></i></div>
                    </div>
                    <input type="file" id="profile-upload" class="hidden" accept="image/*" onchange="window.app.auth.handleProfileImage(this)">
                    <h3 id="profile-name" class="font-bold text-xl text-slate-800">ì‚¬ìš©ì</h3>
                    <p id="profile-email" class="text-xs text-slate-400 mt-1">user@example.com</p>
                    <div class="mt-4 bg-white p-2 rounded-lg border border-slate-100 inline-block">
                        <div class="text-[10px] text-slate-400 font-bold">Total XP</div>
                        <div class="text-lg font-bold text-purple-600" id="profile-xp">0</div>
                    </div>
                </div>
                <div class="space-y-2"><button onclick="window.app.auth.logout()" class="w-full border border-slate-200 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-50 transition">ë¡œê·¸ì•„ì›ƒ</button><button onclick="window.app.auth.showDeleteConfirm()" class="w-full text-red-400 hover:text-red-600 text-xs font-medium py-2 transition">íšŒì› íƒˆí‡´</button></div>
            </div>
            <div id="delete-confirm-container" class="hidden text-center space-y-6 py-4">
                <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto text-2xl animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div><h3 class="font-bold text-lg text-slate-800 mb-2">ì •ë§ë¡œ íƒˆí‡´ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3><p class="text-sm text-slate-500 leading-relaxed">íƒˆí‡´ ì‹œ ëª¨ë“  ìš´ë™ ê¸°ë¡ê³¼ ë°ì´í„°ê°€<br>ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>
                <div class="flex gap-3"><button onclick="window.app.auth.switchTab('profile')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-xl transition">ì•„ë‹ˆìš”</button><button onclick="window.app.auth.deleteAccount()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-red-200 transition">íƒˆí‡´í•©ë‹ˆë‹¤</button></div>
            </div>
            <button onclick="window.app.auth.closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <!-- Toast & Review Modal -->
    <div id="toast-container" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 w-max max-w-[90vw] pointer-events-none"></div>
    <div id="review-modal" class="fixed inset-0 z-50 hidden opacity-0 pointer-events-none modal">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="window.app.reviews.closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] md:w-full max-w-sm rounded-2xl shadow-2xl p-6">
            <h3 class="font-bold text-lg mb-1">ë¦¬ë·° ì‘ì„±</h3><p id="modal-place-name" class="text-xs text-primary font-bold mb-4"></p>
            <div class="space-y-4">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <input type="range" id="rev-rating-slider" min="1" max="5" step="0.1" value="5" class="star-range flex-1" oninput="window.app.reviews.updateStarDisplay(this.value)">
                    <span class="font-bold text-xl text-amber-500 w-12 text-right" id="rev-rating-text">5.0</span>
                </div>
                <div class="flex justify-center gap-1 text-xl mb-2 star-display" id="star-display">
                    <i class="fa-solid fa-star text-amber-400"></i><i class="fa-solid fa-star text-amber-400"></i><i class="fa-solid fa-star text-amber-400"></i><i class="fa-solid fa-star text-amber-400"></i><i class="fa-solid fa-star text-amber-400"></i>
                </div>
                <textarea id="rev-content" rows="4" class="w-full border rounded-lg p-2 text-sm" placeholder="ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš” (2ê¸€ì ì´ìƒ, ë¹„ì†ì–´ ê¸ˆì§€)"></textarea>
                <button onclick="window.app.reviews.submit()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl">ë“±ë¡í•˜ê¸°</button>
            </div>
            <button onclick="window.app.reviews.closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, updateProfile, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, addDoc, query, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (firebaseConfig) {
            const fbApp = initializeApp(firebaseConfig);
            window.db = getFirestore(fbApp);
            window.auth = getAuth(fbApp);
            window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            window.fb = { 
                signInAnonymously, updateProfile, signOut, deleteUser,
                collection, doc, setDoc, getDocs, getDoc, addDoc, query, onSnapshot, deleteDoc, updateDoc
            };
            
            const initAuth = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (e) {
                    console.error("Auth Init Failed:", e);
                    await signInAnonymously(window.auth);
                }
            };
            
            initAuth();

            onAuthStateChanged(window.auth, (user) => {
                window.fbUser = user;
                if(window.app && window.app.auth) window.app.auth.setReady();
                if(window.app && window.app.auth) window.app.auth.updateUI(!!user, user?.displayName || 'ì‚¬ìš©ì', user?.email);
            });
        } else {
            console.log("Local Mode Detected");
            setTimeout(() => {
                if(window.app && window.app.auth) window.app.auth.setReady();
                window.app.auth.updateUI(false);
            }, 500);
        }
    </script>

    <!-- APP LOGIC -->
    <script>
        // Fix: Wait for window load before initializing to prevent null reference errors
        window.onload = function() {
            if (typeof init === 'function') { init(); } 
            else if (typeof app !== 'undefined' && typeof app.init === 'function') { app.init(); }
            // If google maps is loaded, try to init map
            if(window.app && window.app.map && typeof google !== 'undefined' && google.maps) {
                setTimeout(() => { if(!window.app.map.instance) window.app.map.init(); }, 1000); 
            }
        };

        const isLocalMode = typeof __firebase_config === 'undefined';
        const CITY_COORDINATES = { 'ì „êµ­': { lat: 36.35, lng: 127.8, zoom: 7 }, 'ì„œìš¸íŠ¹ë³„ì‹œ': { lat: 37.5665, lng: 126.9780, zoom: 11 }, 'ë¶€ì‚°ê´‘ì—­ì‹œ': { lat: 35.1796, lng: 129.0756, zoom: 11 }, 'ëŒ€êµ¬ê´‘ì—­ì‹œ': { lat: 35.8722, lng: 128.6014, zoom: 11 }, 'ì¸ì²œê´‘ì—­ì‹œ': { lat: 37.4563, lng: 126.7052, zoom: 10 }, 'ê´‘ì£¼ê´‘ì—­ì‹œ': { lat: 35.1595, lng: 126.8526, zoom: 11 }, 'ëŒ€ì „ê´‘ì—­ì‹œ': { lat: 36.3504, lng: 127.3845, zoom: 11 }, 'ìš¸ì‚°ê´‘ì—­ì‹œ': { lat: 35.5384, lng: 129.3114, zoom: 11 }, 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': { lat: 36.5049, lng: 127.2458, zoom: 11 }, 'ê²½ê¸°ë„': { lat: 37.4138, lng: 127.5183, zoom: 9 }, 'ê°•ì›íŠ¹ë³„ìì¹˜ë„': { lat: 37.8853, lng: 128.2527, zoom: 9 }, 'ì¶©ì²­ë¶ë„': { lat: 36.8, lng: 127.7, zoom: 9 }, 'ì¶©ì²­ë‚¨ë„': { lat: 36.5184, lng: 126.8, zoom: 9 }, 'ì „ë¶íŠ¹ë³„ìì¹˜ë„': { lat: 35.8202, lng: 127.1088, zoom: 9 }, 'ì „ë¼ë‚¨ë„': { lat: 34.8679, lng: 126.9910, zoom: 9 }, 'ê²½ìƒë¶ë„': { lat: 36.4919, lng: 128.8887, zoom: 9 }, 'ê²½ìƒë‚¨ë„': { lat: 35.2598, lng: 128.6647, zoom: 9 }, 'ì œì£¼íŠ¹ë³„ìì¹˜ë„': { lat: 33.4996, lng: 126.5312, zoom: 10 } };
        const ADMIN_DATA = { 'ì„œìš¸íŠ¹ë³„ì‹œ': ['ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ê´‘ì§„êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘ë‘êµ¬', 'ì„±ë¶êµ¬', 'ê°•ë¶êµ¬', 'ë„ë´‰êµ¬', 'ë…¸ì›êµ¬', 'ì€í‰êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ì„œì´ˆêµ¬', 'ê°•ë‚¨êµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬'], 'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ì„œêµ¬', 'ë™êµ¬', 'ì˜ë„êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë™ë˜êµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'í•´ìš´ëŒ€êµ¬', 'ì‚¬í•˜êµ¬', 'ê¸ˆì •êµ¬', 'ê°•ì„œêµ¬', 'ì—°ì œêµ¬', 'ìˆ˜ì˜êµ¬', 'ì‚¬ìƒêµ¬', 'ê¸°ì¥êµ°'], 'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ìˆ˜ì„±êµ¬', 'ë‹¬ì„œêµ¬', 'ë‹¬ì„±êµ°'], 'ì¸ì²œê´‘ì—­ì‹œ': ['ê³„ì–‘êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ë‚¨ë™êµ¬', 'ë™êµ¬', 'ë¶€í‰êµ¬', 'ì„œêµ¬', 'ì—°ìˆ˜êµ¬', 'ì¤‘êµ¬', 'ê°•í™”êµ°', 'ì˜¹ì§„êµ°'], 'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ê´‘ì‚°êµ¬'], 'ëŒ€ì „ê´‘ì—­ì‹œ': ['ë™êµ¬', 'ì¤‘êµ¬', 'ì„œêµ¬', 'ìœ ì„±êµ¬', 'ëŒ€ë•êµ¬'], 'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ìš¸ì£¼êµ°'], 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ'], 'ê²½ê¸°ë„': ['ìˆ˜ì›ì‹œ', 'ê³ ì–‘ì‹œ', 'ìš©ì¸ì‹œ', 'ì„±ë‚¨ì‹œ', 'ë¶€ì²œì‹œ', 'ì•ˆì‚°ì‹œ', 'ì•ˆì–‘ì‹œ', 'í™”ì„±ì‹œ', 'í‰íƒì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ', 'ê´‘ì£¼ì‹œ', 'ê´‘ëª…ì‹œ', 'êµ°í¬ì‹œ', 'í•˜ë‚¨ì‹œ', 'ì˜¤ì‚°ì‹œ', 'ì´ì²œì‹œ', 'ì•ˆì„±ì‹œ', 'ì˜ì™•ì‹œ', 'ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ', 'ì—¬ì£¼ì‹œ', 'ì—°ì²œêµ°', 'ê°€í‰êµ°', 'ì–‘í‰êµ°'], 'ê°•ì›íŠ¹ë³„ìì¹˜ë„': ['ì¶˜ì²œì‹œ', 'ì›ì£¼ì‹œ', 'ê°•ë¦‰ì‹œ', 'ë™í•´ì‹œ', 'íƒœë°±ì‹œ', 'ì†ì´ˆì‹œ', 'ì‚¼ì²™ì‹œ', 'í™ì²œêµ°', 'íš¡ì„±êµ°', 'ì˜ì›”êµ°', 'í‰ì°½êµ°', 'ì •ì„ êµ°', 'ì² ì›êµ°', 'í™”ì²œêµ°', 'ì–‘êµ¬êµ°', 'ì¸ì œêµ°', 'ê³ ì„±êµ°', 'ì–‘ì–‘êµ°'], 'ì¶©ì²­ë¶ë„': ['ì²­ì£¼ì‹œ', 'ì¶©ì£¼ì‹œ', 'ì œì²œì‹œ', 'ë³´ì€êµ°', 'ì˜¥ì²œêµ°', 'ì˜ë™êµ°', 'ì§„ì²œêµ°', 'ê´´ì‚°êµ°', 'ìŒì„±êµ°', 'ë‹¨ì–‘êµ°', 'ì¦í‰êµ°'], 'ì¶©ì²­ë‚¨ë„': ['ì²œì•ˆì‹œ', 'ê³µì£¼ì‹œ', 'ë³´ë ¹ì‹œ', 'ì•„ì‚°ì‹œ', 'ì„œì‚°ì‹œ', 'ë…¼ì‚°ì‹œ', 'ê³„ë£¡ì‹œ', 'ë‹¹ì§„ì‹œ', 'ê¸ˆì‚°êµ°', 'ë¶€ì—¬êµ°', 'ì„œì²œêµ°', 'ì²­ì–‘êµ°', 'í™ì„±êµ°', 'ì˜ˆì‚°êµ°', 'íƒœì•ˆêµ°'], 'ì „ë¶íŠ¹ë³„ìì¹˜ë„': ['ì „ì£¼ì‹œ', 'êµ°ì‚°ì‹œ', 'ìµì‚°ì‹œ', 'ì •ìì‹œ', 'ë‚¨ì›ì‹œ', 'ê¹€ì œì‹œ', 'ì™„ì£¼êµ°', 'ì§„ì•ˆêµ°', 'ë¬´ì£¼êµ°', 'ì¥ìˆ˜êµ°', 'ì„ì‹¤êµ°', 'ìˆœì°½êµ°', 'ê³ ì°½êµ°', 'ë¶€ì•ˆêµ°'], 'ì „ë¼ë‚¨ë„': ['ëª©í¬ì‹œ', 'ì—¬ìˆ˜ì‹œ', 'ìˆœì²œì‹œ', 'ë‚˜ì£¼ì‹œ', 'ê´‘ì–‘ì‹œ', 'ë‹´ì–‘êµ°', 'ê³¡ì„±êµ°', 'êµ¬ë¡€êµ°', 'ê³ í¥êµ°', 'ë³´ì„±êµ°', 'í™”ìˆœêµ°', 'ì¥í¥êµ°', 'ê°•ì§„êµ°', 'í•´ë‚¨êµ°', 'ì˜ì•”êµ°', 'ë¬´ì•ˆêµ°', 'í•¨í‰êµ°', 'ì˜ê´‘êµ°', 'ì¥ì„±êµ°', 'ì™„ë„êµ°', 'ì§„ë„êµ°', 'ì‹ ì•ˆêµ°'], 'ê²½ìƒë¶ë„': ['í¬í•­ì‹œ', 'ê²½ì£¼ì‹œ', 'ê¹€ì²œì‹œ', 'ì•ˆë™ì‹œ', 'êµ¬ë¯¸ì‹œ', 'ì˜ì£¼ì‹œ', 'ì˜ì²œì‹œ', 'ìƒì£¼ì‹œ', 'ë¬¸ê²½ì‹œ', 'ê²½ì‚°ì‹œ', 'êµ°ìœ„êµ°', 'ì˜ì„±êµ°', 'ì²­ì†¡êµ°', 'ì˜ì–‘êµ°', 'ì˜ë•êµ°', 'ì²­ë„êµ°', 'ê³ ë ¹êµ°', 'ì„±ì£¼êµ°', 'ì¹ ê³¡êµ°', 'ì˜ˆì²œêµ°', 'ë´‰í™”êµ°', 'ìš¸ì§„êµ°', 'ìš¸ë¦‰êµ°'], 'ê²½ìƒë‚¨ë„': ['ì°½ì›ì‹œ', 'ì§„ì£¼ì‹œ', 'í†µì˜ì‹œ', 'ì‚¬ì²œì‹œ', 'ê¹€í•´ì‹œ', 'ë°€ì–‘ì‹œ', 'ê±°ì œì‹œ', 'ì–‘ì‚°ì‹œ', 'ì˜ë ¹êµ°', 'í•¨ì•ˆêµ°', 'ì°½ë…•êµ°', 'ê³ ì„±êµ°', 'ë‚¨í•´êµ°', 'í•˜ë™êµ°', 'ì‚°ì²­êµ°', 'í•¨ì–‘êµ°', 'ê±°ì°½êµ°', 'í•©ì²œêµ°'], 'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì œì£¼ì‹œ', 'ì„œê·€í¬ì‹œ'] };
        const PLACE_TYPES = { 'gym': 'í—¬ìŠ¤ì¥', 'swimming_pool': 'ìˆ˜ì˜ì¥', 'park': 'ê³µì›', 'stadium': 'ê²½ê¸°ì¥', 'spa': 'ì‚¬ìš°ë‚˜/ìŠ¤íŒŒ', 'store': 'ìŠ¤í¬ì¸  ìš©í’ˆì ', 'sports_complex': 'ì¢…í•© ìš´ë™ì¥' };
        const WORKOUT_GUIDE = {
            'ê°€ìŠ´': [{ name: 'ë²¤ì¹˜ í”„ë ˆìŠ¤', desc: 'ê°€ìŠ´ ê·¼ìœ¡ ì „ì²´ë¥¼ ë°œë‹¬ì‹œí‚¤ëŠ” 3ëŒ€ ìš´ë™' }, { name: 'ì¸í´ë¼ì¸ ë²¤ì¹˜', desc: 'ìœ—ê°€ìŠ´ ë³¼ë¥¨ì„ ì±„ì›Œ ì‡„ê³¨ ë¼ì¸ ì™„ì„±' }, { name: 'ë¤ë²¨ í”„ë ˆìŠ¤', desc: 'ê°€ë™ ë²”ìœ„ í™•ë³´ ë° ìˆ˜ì¶•ê° ê·¹ëŒ€í™”' }, { name: 'í‘¸ì‰¬ì—…', desc: 'ìµœê³ ì˜ ë§¨ëª¸ ê°€ìŠ´ ìš´ë™' }, { name: 'ë”¥ìŠ¤', desc: 'ì•„ë«ê°€ìŠ´ ë¼ì¸ ë° ì‚¼ë‘ ê°•í™”' }, { name: 'ì¼€ì´ë¸” í¬ë¡œìŠ¤ì˜¤ë²„', desc: 'ê°€ìŠ´ ì•ˆìª½ ê¹Šì€ ìê·¹' }],
            'ë“±': [{ name: 'í’€ì—…', desc: 'ë„“ì€ ë“±ì„ ë§Œë“œëŠ” ìµœê³ ì˜ ë§¨ëª¸ ìš´ë™' }, { name: 'ë°ë“œë¦¬í”„íŠ¸', desc: 'ì „ì‹  ê·¼ë ¥ ê°•í™” ë° ë‘êº¼ìš´ ë“±' }, { name: 'ë« í’€ ë‹¤ìš´', desc: 'ê´‘ë°°ê·¼ ê³ ë¦½ ë° ìê·¹' }, { name: 'ë°”ë²¨ ë¡œìš°', desc: 'ë“±ì˜ ë‘ê»˜ê° í–¥ìƒ' }, { name: 'ì‹œí‹°ë“œ ë¡œìš°', desc: 'ë“± ì¤‘ì•™ë¶€ ë””í…Œì¼ ì™„ì„±' }, { name: 'ì› ì•” ë¤ë²¨ ë¡œìš°', desc: 'ë“± ê·¼ìœ¡ ë¶ˆê· í˜• í•´ì†Œ' }],
            'í•˜ì²´': [{ name: 'ìŠ¤ì¿¼íŠ¸', desc: 'í•˜ì²´ ìš´ë™ì˜ ì™•, ì „ì²´ ë‹¨ë ¨' }, { name: 'ëŸ°ì§€', desc: 'í™ì—… ë° ê· í˜• ê°ê°' }, { name: 'ë ˆê·¸ í”„ë ˆìŠ¤', desc: 'ê³ ì¤‘ëŸ‰ í•˜ì²´ í›ˆë ¨' }, { name: 'ë ˆê·¸ ìµìŠ¤í…ì…˜', desc: 'í—ˆë²…ì§€ ì•ìª½ ë¶„ë¦¬ë„' }, { name: 'ë ˆê·¸ ì»¬', desc: 'í—ˆë²…ì§€ ë’¤ìª½ ê°•í™”' }, { name: 'ì¹´í”„ ë ˆì´ì¦ˆ', desc: 'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ë‹¨ë ¨' }],
            'ì–´ê¹¨': [{ name: 'ì˜¤ë²„í—¤ë“œ í”„ë ˆìŠ¤', desc: 'ì–´ê¹¨ ì „ì²´ í¬ê¸° ë° ê·¼ë ¥' }, { name: 'ì‚¬ì´ë“œ ë ˆí„°ëŸ´ ë ˆì´ì¦ˆ', desc: 'ì–´ê¹¨ ì¸¡ë©´, ë„“ì€ ì–´ê¹¨' }, { name: 'ë¤ë²¨ ìˆ„ë” í”„ë ˆìŠ¤', desc: 'ê· í˜• ì¡íŒ ì–´ê¹¨ ë°œë‹¬' }, { name: 'í˜ì´ìŠ¤ í’€', desc: 'í›„ë©´ ì–´ê¹¨, ë¼ìš´ë“œ ìˆ„ë” êµì •' }, { name: 'í”„ë¡ íŠ¸ ë ˆì´ì¦ˆ', desc: 'ì „ë©´ ì–´ê¹¨ ë¶„ë¦¬' }, { name: 'ë²¤íŠ¸ ì˜¤ë²„ ë ˆì´ì¦ˆ', desc: 'í›„ë©´ ì–´ê¹¨ ì…ì²´ê°' }],
            'íŒ”': [{ name: 'ë°”ë²¨ ì»¬', desc: 'ì´ë‘ê·¼ í¬ê¸° ì¦ê°€' }, { name: 'ë¤ë²¨ ì»¬', desc: 'ì´ë‘ê·¼ ì•ˆìª½ ìê·¹' }, { name: 'í•´ë¨¸ ì»¬', desc: 'ì´ë‘ ë°”ê¹¥ìª½ ë° ì „ì™„ê·¼' }, { name: 'íŠ¸ë¼ì´ì…‰ìŠ¤ ìµìŠ¤í…ì…˜', desc: 'ì‚¼ë‘ê·¼ ì¥ë‘ ë³¼ë¥¨' }, { name: 'ì¼€ì´ë¸” í‘¸ì‰¬ ë‹¤ìš´', desc: 'ì‚¼ë‘ ì™¸ì¸¡ë‘ ìê·¹' }, { name: 'í´ë¡œì¦ˆ ê·¸ë¦½ ë²¤ì¹˜', desc: 'ì‚¼ë‘ ì „ì²´ ê³ ì¤‘ëŸ‰' }],
            'ë³µê·¼': [{ name: 'í”Œë­í¬', desc: 'ì½”ì–´ ì „ì²´ ê°•í™”' }, { name: 'í–‰ì‰ ë ˆê·¸ ë ˆì´ì¦ˆ', desc: 'í•˜ë³µë¶€ ê°•ë ¥ ìê·¹' }, { name: 'í¬ëŸ°ì¹˜', desc: 'ìƒë³µë¶€ ì§‘ì¤‘ ìˆ˜ì¶•' }, { name: 'ëŸ¬ì‹œì•ˆ íŠ¸ìœ„ìŠ¤íŠ¸', desc: 'ì˜†êµ¬ë¦¬ ë¼ì¸' }, { name: 'ë°”ì´ì‹œí´ í¬ëŸ°ì¹˜', desc: 'ìƒí•˜ë³µë¶€ ë™ì‹œ ìê·¹' }],
            'ìœ ì‚°ì†Œ/ì „ì‹ ': [{ name: 'ì¸í„°ë²Œ ëŸ¬ë‹', desc: 'ì²´ì§€ë°© ì—°ì†Œ ê·¹ëŒ€í™”' }, { name: 'ì²œêµ­ì˜ ê³„ë‹¨', desc: 'í™ì—… ë° ì¹¼ë¡œë¦¬ í­íŒŒ' }, { name: 'ë²„í”¼ í…ŒìŠ¤íŠ¸', desc: 'ì „ì‹  ê·¼ë ¥ ë° ì‹¬í ì§€êµ¬ë ¥' }, { name: 'ë¡œì‰ ë¨¸ì‹ ', desc: 'ì „ì‹  ì‚¬ìš©, ê´€ì ˆ ë³´í˜¸' }, { name: 'ì¤„ë„˜ê¸°', desc: 'ë¯¼ì²©ì„± ë° ì‹¬í ì§€êµ¬ë ¥' }]
        };
        const PAIN_FOODS = { neck: 'ë°”ë‚˜ë‚˜, ì•„ëª¬ë“œ (ë§ˆê·¸ë„¤ìŠ˜)', shoulder: 'ì–‘íŒŒ, ë¶€ì¶” (í˜ˆì•¡ìˆœí™˜)', elbow: 'ë“±í‘¸ë¥¸ ìƒì„ , ì—°ì–´ (í•­ì—¼)', wrist: 'ê°ê·¤ë¥˜ (ë¹„íƒ€ë¯¼C/ì½œë¼ê²)', back: 'ìš°ìœ , ë©¸ì¹˜ (ì¹¼ìŠ˜)', pelvis: 'í† ë§ˆí† , ë¸Œë¡œì½œë¦¬ (ì—¼ì¦ ì™„í™”)', knee: 'ë„ê°€ë‹ˆíƒ•, í•´ì¡°ë¥˜ (ì—°ê³¨)', ankle: 'ë‹­ê°€ìŠ´ì‚´ (ë‹¨ë°±ì§ˆ/ì¸ëŒ€)', muscle: 'ì‹ì´ˆ, ë§¤ì‹¤ (í”¼ë¡œ íšŒë³µ)' };

        const MISSION_POOL = [
            { id: 'm1', title: 'ì•„ì¹¨ ê³µë³µ ìœ ì‚°ì†Œ', desc: 'ê°€ë³ê²Œ 30ë¶„ ê±·ê¸°', xp: 50, icon: 'fa-person-walking' },
            { id: 'm2', title: 'ë¬¼ ë§ˆì‹œê¸°', desc: 'í•˜ë£¨ 2ë¦¬í„° ìˆ˜ë¶„ ë³´ì¶©', xp: 30, icon: 'fa-bottle-water' },
            { id: 'm3', title: 'ìŠ¤ì¿¼íŠ¸ ì±Œë¦°ì§€', desc: 'ìŠ¤ì¿¼íŠ¸ 50íšŒ ìˆ˜í–‰', xp: 100, icon: 'fa-dumbbell' },
            { id: 'm4', title: 'í”Œë­í¬ ë²„í‹°ê¸°', desc: 'ì´ 3ë¶„ ë²„í‹°ê¸°', xp: 80, icon: 'fa-stopwatch' },
            { id: 'm5', title: 'ê³„ë‹¨ ì˜¤ë¥´ê¸°', desc: '10ì¸µ ì´ìƒ ê³„ë‹¨ ì´ìš©', xp: 60, icon: 'fa-stairs' },
            { id: 'm6', title: 'ìŠ¤íŠ¸ë ˆì¹­', desc: 'ìê¸° ì „ 10ë¶„ ìŠ¤íŠ¸ë ˆì¹­', xp: 40, icon: 'fa-child-reaching' },
            { id: 'm7', title: 'ì±„ì†Œ ë¨¹ê¸°', desc: 'í•œ ë¼ ì´ìƒ ì±„ì†Œ ì„­ì·¨', xp: 50, icon: 'fa-carrot' },
            { id: 'm8', title: 'ëª…ìƒí•˜ê¸°', desc: '5ë¶„ê°„ ë§ˆìŒì±™ê¹€ ëª…ìƒ', xp: 30, icon: 'fa-brain' },
            { id: 'm9', title: 'ëŸ°ì§€ ì±Œë¦°ì§€', desc: 'ëŸ°ì§€ ì–‘ë°œ 20íšŒ', xp: 80, icon: 'fa-person-running' },
            { id: 'm10', title: 'ë§Œë³´ ê±·ê¸°', desc: 'í•˜ë£¨ 10,000ë³´ ë‹¬ì„±', xp: 150, icon: 'fa-shoe-prints' },
            { id: 'm11', title: 'ì•¼ì‹ ì°¸ê¸°', desc: 'ì €ë… 8ì‹œ ì´í›„ ê¸ˆì‹', xp: 60, icon: 'fa-ban' },
            { id: 'm12', title: 'í‘¸ì‰¬ì—…', desc: 'í‘¸ì‰¬ì—… 30íšŒ ìˆ˜í–‰', xp: 90, icon: 'fa-hand-fist' }
        ];

        const WEEKLY_MISSIONS = [
            { id: 'w1', title: 'í—¬ìŠ¤ì¥ ì¶œì„ì™•', desc: 'ì´ë²ˆ ì£¼ 3íšŒ ì´ìƒ ë°©ë¬¸', xp: 300, icon: 'fa-building' },
            { id: 'w2', title: 'ëŸ¬ë‹ ë§ˆìŠ¤í„°', desc: 'ëˆ„ì  10km ë‹¬ë¦¬ê¸°', xp: 500, icon: 'fa-person-running' }
        ];

        const BAD_WORDS = ['ë°”ë³´', 'ë©ì²­ì´', 'ì”¨ë°œ', 'ê°œìƒˆë¼', 'ì§€ë„', 'ë¯¸ì¹œ', 'ë³‘ì‹ ', 'ì¡´ë‚˜', 'ìƒˆë¼', 'ë†ˆ'];
        const ALLOWED_ENGLISH_TERMS = ['squat', 'bench', 'press', 'deadlift', 'curl', 'row', 'pull', 'push', 'up', 'down', 'gym', 'fitness', 'cardio', 'running', 'yoga', 'pilates', 'crossfit', 'lunge', 'plank', 'crunch', 'situp', 'leg', 'arm', 'chest', 'back', 'shoulder', 'abs'];

        function isValidContent(text) {
            if (!text) return false;
            const trimText = text.trim();
            if (trimText.length < 2) return false;
            for (let bad of BAD_WORDS) { if (trimText.includes(bad)) return false; }
            const meaningfulRegex = /[ê°€-í£a-zA-Z0-9]/;
            if (!meaningfulRegex.test(trimText)) return false;
            if (/[a-zA-Z]/.test(trimText)) {
                const lowerText = trimText.toLowerCase();
                const hasAllowedTerm = ALLOWED_ENGLISH_TERMS.some(term => lowerText.includes(term));
                if (!hasAllowedTerm) return false; 
            }
            return true;
        }
        
        function isValidReview(text) {
            if (!text) return false;
            const trimText = text.trim();
            if (trimText.length < 2) return false;
            for (let bad of BAD_WORDS) { if (trimText.includes(bad)) return false; }
            const meaningfulRegex = /[ê°€-í£a-zA-Z0-9]/;
            if (!meaningfulRegex.test(trimText)) return false;
            return true;
        }

        window.app = {
            state: {
                isLoggedIn: false,
                currentUserId: null, 
                currentUserName: null,
                currentPlace: null,
                selectedDate: new Date().toISOString().split('T')[0],
                calendarDate: new Date(),
                workoutData: {},
                missionData: {}, 
                isAuthReady: false
            },
            toggleMobileMenu: () => {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
                // Small delay to allow display:block to apply before opacity transition
                if (!menu.classList.contains('hidden')) {
                    setTimeout(() => menu.classList.add('open'), 10);
                } else {
                    menu.classList.remove('open');
                }
            },
            ui: {
                toast: (msg) => {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    el.className = "bg-slate-800/90 backdrop-blur text-white px-4 py-3 rounded-lg shadow-xl text-sm font-medium opacity-0 transition-all duration-300 transform translate-y-4 text-center";
                    el.textContent = msg;
                    container.appendChild(el);
                    requestAnimationFrame(() => { el.classList.remove('opacity-0', 'translate-y-4'); });
                    setTimeout(() => { el.classList.add('opacity-0', 'translate-y-[-10px]'); setTimeout(() => el.remove(), 300); }, 3000);
                }
            },
            router: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                // Close mobile menu if open
                const menu = document.getElementById('mobile-menu');
                if (!menu.classList.contains('hidden')) {
                    menu.classList.remove('open');
                    setTimeout(() => menu.classList.add('hidden'), 300);
                }
                
                window.scrollTo(0,0);
                if(viewId === 'map') setTimeout(() => window.app.map.resize(), 100);
                if(viewId === 'workout') window.app.calendar.render();
                if(viewId === 'fitness') window.app.tools.initGuide();
                if(viewId === 'bookmarks') window.app.bookmarks.render();
                if(viewId === 'challenge') window.app.challenges.render();
            },
            
            auth: {
                mode: 'login',
                init: (firebaseUser) => { window.app.auth.updateUI(false); },
                setReady: () => {
                    window.app.state.isAuthReady = true;
                    const btn = document.getElementById('auth-submit-btn');
                    if(btn) {
                        btn.disabled = false;
                        btn.classList.remove('bg-slate-300', 'cursor-not-allowed');
                        btn.classList.add('bg-primary', 'hover:bg-indigo-600');
                        window.app.auth.switchTab(window.app.auth.mode);
                    }
                },
                updateUI: (isLoggedIn, name, email) => {
                    // Desktop Nav Elements
                    const navGuest = document.getElementById('nav-guest');
                    const navUser = document.getElementById('nav-user');
                    // Mobile Nav Elements
                    const mNavGuest = document.getElementById('mobile-nav-guest');
                    const mNavUser = document.getElementById('mobile-nav-user');
                    
                    const woGuest = document.getElementById('workout-guest-msg');
                    const woContent = document.getElementById('workout-content');
                    
                    window.app.state.isLoggedIn = isLoggedIn;
                    
                    if (isLoggedIn) {
                        if(isLocalMode) {
                            window.app.state.currentUserId = 'local_user';
                            window.app.state.currentUserName = name;
                        } else if (window.fbUser) {
                            window.app.state.currentUserId = window.fbUser.uid;
                            window.app.state.currentUserName = window.fbUser.displayName;
                        }
                    } else {
                        window.app.state.currentUserId = null;
                        window.app.state.currentUserName = null;
                    }

                    if (isLoggedIn) {
                        // Desktop
                        navGuest.classList.add('hidden');
                        navUser.classList.remove('hidden');
                        navUser.classList.add('flex');
                        document.getElementById('nav-username').textContent = name + 'ë‹˜';
                        
                        // Mobile
                        if(mNavGuest) mNavGuest.classList.add('hidden');
                        if(mNavUser) {
                            mNavUser.classList.remove('hidden');
                            mNavUser.classList.add('flex');
                            document.getElementById('mobile-nav-username').textContent = name + 'ë‹˜';
                        }

                        if(email) document.getElementById('profile-email').textContent = email;
                        if(name) document.getElementById('profile-name').textContent = name;
                        
                        if(woGuest) woGuest.classList.add('hidden');
                        if(woContent) {
                            woContent.classList.remove('hidden');
                            woContent.classList.add('flex');
                        }
                        window.app.challenges.loadData(); 
                    } else {
                        // Desktop
                        navGuest.classList.remove('hidden');
                        navUser.classList.add('hidden');
                        navUser.classList.remove('flex');
                        
                        // Mobile
                        if(mNavGuest) mNavGuest.classList.remove('hidden');
                        if(mNavUser) {
                            mNavUser.classList.add('hidden');
                            mNavUser.classList.remove('flex');
                        }
                        
                        if(woGuest) woGuest.classList.remove('hidden');
                        if(woContent) {
                            woContent.classList.add('hidden');
                            woContent.classList.remove('flex');
                        }
                    }
                    
                    const currentView = document.querySelector('.view-section:not(.hidden)');
                    if (currentView && currentView.id === 'view-challenge') window.app.challenges.render();
                    if (currentView && currentView.id === 'view-workout' && isLoggedIn) window.app.calendar.render();
                },
                openModal: (mode) => {
                    // Close mobile menu if open
                    const menu = document.getElementById('mobile-menu');
                    if (!menu.classList.contains('hidden')) {
                        menu.classList.remove('open');
                        setTimeout(() => menu.classList.add('hidden'), 300);
                    }

                    const modal = document.getElementById('auth-modal');
                    modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
                    window.app.auth.switchTab(mode);
                    ['auth-name','auth-email','auth-pw'].forEach(id => document.getElementById(id).value = '');
                },
                closeModal: () => {
                    const modal = document.getElementById('auth-modal');
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => modal.classList.add('hidden'), 250);
                },
                switchTab: async (mode) => {
                    window.app.auth.mode = mode;
                    const tabs = document.getElementById('auth-tabs');
                    const form = document.getElementById('form-container');
                    const profileTitle = document.getElementById('profile-title');
                    const profileView = document.getElementById('profile-container');
                    const deleteView = document.getElementById('delete-confirm-container');
                    
                    tabs.classList.add('hidden');
                    form.classList.add('hidden');
                    profileTitle.classList.add('hidden');
                    profileView.classList.add('hidden');
                    deleteView.classList.add('hidden');

                    if (!window.app.state.isAuthReady && mode !== 'profile' && mode !== 'delete_confirm') { 
                        tabs.classList.remove('hidden'); 
                        form.classList.remove('hidden'); 
                        return; 
                    }

                    if (mode === 'profile') {
                        profileTitle.classList.remove('hidden');
                        profileView.classList.remove('hidden');
                        
                        let userName = 'ì‚¬ìš©ì';
                        let userEmail = 'ì´ë©”ì¼ ì •ë³´ ì—†ìŒ';
                        let userId = 'guest';

                        if (isLocalMode) {
                            userName = localStorage.getItem('sp_userName') || 'ì‚¬ìš©ì';
                            userId = 'local_user';
                            userEmail = localStorage.getItem('sp_email') || 'ì´ë©”ì¼ ì •ë³´ ì—†ìŒ';
                        } else if (window.fbUser) {
                            userName = window.fbUser.displayName || 'ì‚¬ìš©ì';
                            userId = window.fbUser.uid;
                            userEmail = window.fbUser.email;
                        }

                        document.getElementById('profile-name').textContent = userName;
                        document.getElementById('profile-email').textContent = userEmail;

                        const savedImg = localStorage.getItem(`sp_profile_img_${userId}`);
                        const imgEl = document.getElementById('profile-img');
                        const holderEl = document.getElementById('profile-placeholder');
                        
                        if (savedImg) {
                            imgEl.src = savedImg;
                            imgEl.classList.remove('hidden');
                            holderEl.classList.add('hidden');
                        } else {
                            imgEl.classList.add('hidden');
                            holderEl.classList.remove('hidden');
                        }
                        
                        const xp = await window.app.challenges.getTotalXP();
                        document.getElementById('profile-xp').textContent = xp + ' XP';

                    } else if (mode === 'delete_confirm') {
                        deleteView.classList.remove('hidden');
                    } else {
                        tabs.classList.remove('hidden');
                        form.classList.remove('hidden');
                        const btn = document.getElementById('auth-submit-btn');
                        const tLogin = document.getElementById('tab-login');
                        const tSignup = document.getElementById('tab-signup');

                        if (mode === 'signup') {
                            document.getElementById('field-name').classList.remove('hidden'); 
                            if(btn) { btn.textContent = 'ê°€ì…í•˜ê¸°'; btn.innerHTML = 'ê°€ì…í•˜ê¸°'; }
                            tSignup.className = "flex-1 py-2 text-primary border-b-2 border-primary font-bold";
                            tLogin.className = "flex-1 py-2 text-slate-400 font-medium";
                        } else {
                            document.getElementById('field-name').classList.add('hidden'); 
                            if(btn) { btn.textContent = 'ë¡œê·¸ì¸'; btn.innerHTML = 'ë¡œê·¸ì¸'; }
                            tLogin.className = "flex-1 py-2 text-primary border-b-2 border-primary font-bold";
                            tSignup.className = "flex-1 py-2 text-slate-400 font-medium";
                        }
                    }
                },
                handleProfileImage: (input) => {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        if (file.size > 2 * 1024 * 1024) {
                            window.app.ui.toast("ì‚¬ì§„ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (2MB ì´í•˜ ê¶Œì¥)");
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64Img = e.target.result;
                            const imgEl = document.getElementById('profile-img');
                            const holderEl = document.getElementById('profile-placeholder');
                            imgEl.src = base64Img;
                            imgEl.classList.remove('hidden');
                            holderEl.classList.add('hidden');
                            let userId = 'guest';
                            if (isLocalMode) userId = 'local_user';
                            else if (window.fbUser) userId = window.fbUser.uid;
                            try {
                                localStorage.setItem(`sp_profile_img_${userId}`, base64Img);
                                window.app.ui.toast("í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
                            } catch (err) { console.error(err); window.app.ui.toast("ì €ì¥ ê³µê°„ ë¶€ì¡±"); }
                        };
                        reader.readAsDataURL(file);
                    }
                },
                submit: async () => {
                    const email = document.getElementById('auth-email').value;
                    const pw = document.getElementById('auth-pw').value;
                    const name = document.getElementById('auth-name').value;
                    
                    if (!isLocalMode && (!window.fb || !window.fbUser)) return window.app.ui.toast("ì„œë²„ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤.");
                    if (window.app.auth.mode === 'signup' && !name) return window.app.ui.toast("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    if (!email || !pw) return window.app.ui.toast("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                    if (window.app.auth.mode === 'signup') {
                        const bannedTime = localStorage.getItem(`banned_${email}`);
                        if (bannedTime) {
                            const diffDays = (Date.now() - parseInt(bannedTime)) / (1000 * 60 * 60 * 24);
                            if (diffDays < 7) return window.app.ui.toast(`íƒˆí‡´ í›„ 7ì¼ê°„ì€ ì¬ê°€ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${Math.ceil(7-diffDays)}ì¼ ë‚¨ìŒ)`);
                            else localStorage.removeItem(`banned_${email}`);
                        }
                    }

                    if (isLocalMode) {
                        let storedUsers = JSON.parse(localStorage.getItem('sp_users') || '{}');
                        
                        if (window.app.auth.mode === 'signup') {
                            if (storedUsers[email]) return window.app.ui.toast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.");
                            storedUsers[email] = { name: name, password: pw }; 
                            localStorage.setItem('sp_users', JSON.stringify(storedUsers));
                            
                            window.app.state.isLoggedIn = true;
                            localStorage.setItem('sp_isLoggedIn', 'true');
                            localStorage.setItem('sp_userName', name);
                            localStorage.setItem('sp_email', email);
                            window.app.auth.updateUI(true, name, email);
                            window.app.auth.closeModal();
                            window.app.ui.toast(`${name}ë‹˜, ê°€ì…ì„ í™˜ì˜í•©ë‹ˆë‹¤! (ë¡œì»¬ ëª¨ë“œ)`);
                        } else {
                            if (!storedUsers[email] || storedUsers[email].password !== pw) {
                                return window.app.ui.toast("ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                            }
                            const userName = storedUsers[email].name;
                            window.app.state.isLoggedIn = true;
                            localStorage.setItem('sp_isLoggedIn', 'true');
                            localStorage.setItem('sp_userName', userName);
                            localStorage.setItem('sp_email', email);
                            window.app.auth.updateUI(true, userName, email);
                            window.app.auth.closeModal();
                            window.app.ui.toast(`${userName}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! (ë¡œì»¬ ëª¨ë“œ)`);
                        }
                        window.app.calendar.fetchData();
                        return;
                    }

                    if (window.app.auth.mode === 'signup') {
                        try {
                            await window.fb.updateProfile(window.fbUser, { displayName: name });
                            window.app.state.isLoggedIn = true;
                            localStorage.setItem('sp_isLoggedIn', 'true');
                            localStorage.setItem('sp_email', email);
                            window.app.auth.updateUI(true, name, email);
                            window.app.auth.closeModal();
                            window.app.ui.toast(`${name}ë‹˜, ê°€ì…ì„ í™˜ì˜í•©ë‹ˆë‹¤!`);
                            window.app.calendar.fetchData();
                        } catch (e) { window.app.ui.toast("ì˜¤ë¥˜: " + e.message); }
                    } else {
                        const userName = window.fbUser?.displayName || 'ì‚¬ìš©ì';
                        window.app.state.isLoggedIn = true;
                        localStorage.setItem('sp_isLoggedIn', 'true');
                        localStorage.setItem('sp_email', email);
                        window.app.auth.updateUI(true, userName, email);
                        window.app.auth.closeModal();
                        window.app.ui.toast("ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        window.app.calendar.fetchData();
                    }
                },
                showDeleteConfirm: () => { window.app.auth.switchTab('delete_confirm'); },
                deleteAccount: async () => {
                    const currentEmail = localStorage.getItem('sp_email');
                    if (currentEmail) localStorage.setItem(`banned_${currentEmail}`, Date.now().toString());
                    
                    if (isLocalMode) {
                        let storedUsers = JSON.parse(localStorage.getItem('sp_users') || '{}');
                        if(currentEmail) delete storedUsers[currentEmail];
                        localStorage.setItem('sp_users', JSON.stringify(storedUsers));

                        localStorage.removeItem('sp_isLoggedIn'); localStorage.removeItem('sp_userName'); localStorage.removeItem('sp_email'); localStorage.removeItem('sp_workouts'); localStorage.removeItem('sp_reviews');
                        window.app.state.isLoggedIn = false; window.app.state.workoutData = {};
                        window.app.auth.updateUI(false); window.app.auth.closeModal(); window.app.router('home'); window.app.ui.toast("íƒˆí‡´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤ (ë¡œì»¬).");
                        return;
                    }
                    if (!window.fbUser || !window.fb) return;
                    try {
                        await window.fb.deleteUser(window.fbUser);
                        window.app.state.isLoggedIn = false; window.app.state.workoutData = {};
                        localStorage.removeItem('sp_isLoggedIn'); localStorage.removeItem('sp_email');
                        window.app.auth.updateUI(false); window.app.auth.closeModal(); window.app.router('home'); window.app.ui.toast("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch (e) {
                        if (e.code === 'auth/requires-recent-login') { window.app.ui.toast("ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."); window.app.auth.switchTab('login'); }
                        else { window.app.ui.toast("ì˜¤ë¥˜: " + e.message); }
                    }
                },
                logout: async () => {
                    if (window.app.reviews.unsubscribe) window.app.reviews.unsubscribe();

                    if (!isLocalMode) {
                        try { if (window.fb && window.auth) await window.fb.signOut(window.auth); } catch (e) { console.error(e); }
                    }
                    window.app.state.isLoggedIn = false;
                    window.app.state.workoutData = {};
                    localStorage.removeItem('sp_isLoggedIn');
                    window.app.auth.updateUI(false);
                    window.app.router('home');
                    window.app.ui.toast("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            },

            bookmarks: {
                getList: () => { const s = localStorage.getItem('sp_bookmarks'); return s ? JSON.parse(s) : []; },
                toggle: (placeData) => {
                    const list = window.app.bookmarks.getList();
                    const idx = list.findIndex(p => p.place_id === placeData.place_id);
                    if (idx === -1) { list.push(placeData); window.app.ui.toast("ì¦ê²¨ì°¾ê¸° ì¶”ê°€ë¨"); }
                    else { list.splice(idx, 1); window.app.ui.toast("ì¦ê²¨ì°¾ê¸° ì‚­ì œë¨"); }
                    localStorage.setItem('sp_bookmarks', JSON.stringify(list));
                    if (!document.getElementById('view-bookmarks').classList.contains('hidden')) window.app.bookmarks.render();
                    const btn = document.getElementById(`btn-bookmark-${placeData.place_id}`);
                    if(btn) btn.innerHTML = (idx === -1) ? '<i class="fa-solid fa-star text-amber-400"></i>' : '<i class="fa-regular fa-star text-slate-300"></i>';
                },
                render: () => {
                    const list = window.app.bookmarks.getList();
                    const c = document.getElementById('bookmark-list');
                    c.innerHTML = '';
                    if (list.length === 0) { c.innerHTML = '<div class="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl"><i class="fa-regular fa-star text-4xl mb-3 opacity-50"></i><br>ì•„ì§ ì¦ê²¨ì°¾ê¸°í•œ ì‹œì„¤ì´ ì—†ìŠµë‹ˆë‹¤.<br><span class="text-xs mt-2 inline-block">ì§€ë„ì—ì„œ ì‹œì„¤ì„ ê²€ìƒ‰í•˜ê³  ë³„ ì•„ì´ì½˜ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</span></div>'; return; }
                    list.forEach(p => {
                        const el = document.createElement('div');
                        el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start gap-4";
                        const imgHtml = p.photoUrl 
                             ? `<img src="${p.photoUrl}" class="w-20 h-20 rounded-lg object-cover border border-slate-200 bg-slate-100 flex-shrink-0">` 
                             : `<div class="w-20 h-20 rounded-lg bg-slate-100 flex items-center justify-center text-slate-300 flex-shrink-0"><i class="fa-solid fa-image text-2xl"></i></div>`;

                        el.innerHTML = `
                            <div class="flex gap-4 flex-1">
                                ${imgHtml}
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">${p.name}</h3>
                                    <p class="text-sm text-slate-500 mb-1">${p.vicinity || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</p>
                                    ${p.rating ? `<div class="text-xs text-amber-500">â˜… ${p.rating}</div>` : ''}
                                </div>
                            </div>
                            <button onclick='window.app.bookmarks.toggle(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="w-10 h-10 rounded-full bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 transition flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        `;
                        c.appendChild(el);
                    });
                }
            },

            challenges: {
                loadData: async () => {
                    if (!window.app.state.isLoggedIn) return;
                    
                    const today = new Date().toISOString().split('T')[0];
                    let data = {};

                    if (isLocalMode) {
                        const saved = localStorage.getItem(`sp_quest_${window.app.state.currentUserId}`);
                        if (saved) data = JSON.parse(saved);
                    } else { 
                        const saved = localStorage.getItem(`sp_quest_${window.app.state.currentUserId}`);
                        if (saved) data = JSON.parse(saved);
                    }
                    
                    if (data.lastDate !== today || !data.activeDailyMissions) {
                        const shuffled = [...MISSION_POOL].sort(() => 0.5 - Math.random());
                        data.activeDailyMissions = shuffled.slice(0, 3);
                        data.daily = {}; 
                        data.lastDate = today;
                    }
                    if (!data.weekly) data.weekly = {};
                    if (!data.totalXP) data.totalXP = 0;

                    window.app.state.missionData = data;
                    window.app.challenges.render();
                },
                saveData: () => {
                    const uid = window.app.state.currentUserId;
                    if (!uid) return;
                    localStorage.setItem(`sp_quest_${uid}`, JSON.stringify(window.app.state.missionData));
                    window.app.challenges.render();
                },
                toggleMission: (type, id, xp) => {
                    if (!window.app.state.isLoggedIn) return window.app.ui.toast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    
                    const data = window.app.state.missionData;
                    if (type === 'daily') {
                        if (data.daily[id]) return; 
                        data.daily[id] = true;
                        data.totalXP += xp;
                        window.app.ui.toast(`í€˜ìŠ¤íŠ¸ ì™„ë£Œ! +${xp} XP`);
                    } else {
                        if (data.weekly[id]) return;
                        data.weekly[id] = true;
                        data.totalXP += xp;
                        window.app.ui.toast(`ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! +${xp} XP`);
                    }
                    window.app.challenges.saveData();
                },
                getTotalXP: async () => { 
                     if (!window.app.state.missionData || !window.app.state.missionData.totalXP) {
                        await window.app.challenges.loadData();
                     }
                     return window.app.state.missionData ? (window.app.state.missionData.totalXP || 0) : 0;
                },
                render: () => {
                    const dailyList = document.getElementById('daily-quest-list');
                    const weeklyList = document.getElementById('weekly-quest-list');
                    const totalXPDisplay = document.getElementById('total-xp-display');
                    
                    if (!dailyList || !weeklyList) return;
                    
                    dailyList.innerHTML = '';
                    weeklyList.innerHTML = '';

                    if (!window.app.state.isLoggedIn) { 
                         dailyList.innerHTML = '<div class="text-center text-slate-400 py-8">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>'; 
                         weeklyList.innerHTML = '<div class="text-center text-slate-400 py-8">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>'; 
                         return;
                    }

                    const data = window.app.state.missionData;
                    totalXPDisplay.textContent = (data.totalXP || 0) + " XP";

                    let dailyCount = 0;
                    let dailyDone = 0;
                    
                    const activeMissions = data.activeDailyMissions || [];
                    
                    activeMissions.forEach(m => {
                        dailyCount++;
                        const isDone = data.daily && data.daily[m.id];
                        if(isDone) dailyDone++;
                        
                        const el = document.createElement('div');
                        el.className = `quest-card flex items-center p-4 rounded-xl border ${isDone ? 'quest-completed border-emerald-200 bg-emerald-50' : 'border-slate-200 bg-white'} cursor-pointer`;
                        el.onclick = () => window.app.challenges.toggleMission('daily', m.id, m.xp);
                        
                        el.innerHTML = `
                            <div class="quest-icon w-10 h-10 rounded-full flex items-center justify-center text-lg mr-4 ${isDone ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}">
                                <i class="fa-solid ${m.icon}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="quest-title font-bold text-sm text-slate-800 ${isDone ? 'line-through text-emerald-700' : ''}">${m.title}</div>
                                <div class="text-xs text-slate-500">${m.desc}</div>
                            </div>
                            <div class="text-xs font-bold ${isDone ? 'text-emerald-600' : 'text-slate-400'}">
                                ${isDone ? '<i class="fa-solid fa-check"></i> ì™„ë£Œ' : `+${m.xp} XP`}
                            </div>
                        `;
                        dailyList.appendChild(el);
                    });

                    WEEKLY_MISSIONS.forEach(m => { 
                         const isDone = data.weekly && data.weekly[m.id];
                         const el = document.createElement('div');
                         el.className = `quest-card flex items-center p-4 rounded-xl border ${isDone ? 'quest-completed border-blue-200 bg-blue-50' : 'border-slate-200 bg-white'} cursor-pointer`;
                         el.onclick = () => window.app.challenges.toggleMission('weekly', m.id, m.xp);

                         el.innerHTML = `
                            <div class="quest-icon w-10 h-10 rounded-full flex items-center justify-center text-lg mr-4 ${isDone ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-400'}">
                                <i class="fa-solid ${m.icon}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="quest-title font-bold text-sm text-slate-800 ${isDone ? 'line-through text-blue-700' : ''}">${m.title}</div>
                                <div class="text-xs text-slate-500">${m.desc}</div>
                            </div>
                            <div class="text-xs font-bold ${isDone ? 'text-blue-600' : 'text-slate-400'}">
                                ${isDone ? '<i class="fa-solid fa-check"></i> ì™„ë£Œ' : `+${m.xp} XP`}
                            </div>
                        `;
                        weeklyList.appendChild(el);
                    });
                    
                    const progress = dailyCount > 0 ? (dailyDone / dailyCount) * 100 : 0;
                    document.getElementById('daily-progress-bar').style.width = `${progress}%`;
                    document.getElementById('daily-progress-text').textContent = `${Math.round(progress)}%`;
                }
            },

            map: {
                instance: null, service: null, geocoder: null, markers: [], currentInfoWindow: null,
                init: () => {
                    if (window.app.map.instance) return;
                    const container = document.getElementById('map');
                    if (typeof google === 'undefined' || !google.maps) { container.innerHTML = '<div class="flex items-center justify-center h-full bg-slate-100 text-slate-500 text-sm">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
                    window.app.map.instance = new google.maps.Map(container, { center: CITY_COORDINATES['ì „êµ­'], zoom: 7 });
                    window.app.map.service = new google.maps.places.PlacesService(window.app.map.instance);
                    window.app.map.geocoder = new google.maps.Geocoder();
                    const pSel = document.getElementById('province-filter');
                    pSel.innerHTML = '<option value="ì „êµ­">ì „êµ­</option>';
                    Object.keys(CITY_COORDINATES).sort().forEach(k => { if(k!=='ì „êµ­') pSel.add(new Option(k, k)); });
                    pSel.addEventListener('change', function() { window.app.map.updateDistrict(this.value, 'district-filter'); });
                    const tSel = document.getElementById('type-filter');
                    tSel.innerHTML = '';
                    Object.entries(PLACE_TYPES).forEach(([k, v]) => tSel.add(new Option(v, k)));
                    window.app.map.filter();
                },
                updateDistrict: (province, targetId) => {
                    const dSel = document.getElementById(targetId);
                    dSel.innerHTML = '';
                    if (province === 'ì „êµ­' || !ADMIN_DATA[province]) { dSel.add(new Option("ì‹œ/ë„ ì„ íƒ", "")); dSel.disabled = true; }
                    else { dSel.add(new Option("ì „ì²´ ì‹œ/êµ°/êµ¬", "")); ADMIN_DATA[province].sort().forEach(d => dSel.add(new Option(d, d))); dSel.disabled = false; }
                },
                resize: () => { if(window.app.map.instance) google.maps.event.trigger(window.app.map.instance, "resize"); else window.app.map.init(); },
                filter: () => {
                    if (!window.app.map.instance) return;
                    const prov = document.getElementById('province-filter').value || 'ì „êµ­';
                    const dist = document.getElementById('district-filter').value;
                    const typeKey = document.getElementById('type-filter').value;
                    
                    // ë³€ê²½ëœ ë¡œì§: ì…ë ¥ì°½ì— ê°’ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìµœìš°ì„  ê²€ìƒ‰ì–´ë¡œ ì‚¬ìš©
                    const userInput = document.getElementById('map-keyword-input').value.trim();
                    let searchKeyword = userInput; 
                    
                    // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ê²€ìƒ‰ì–´ë¡œ ì‚¬ìš©
                    if (!searchKeyword) {
                        searchKeyword = PLACE_TYPES[typeKey];
                    }

                    if (dist && window.app.map.geocoder) {
                        window.app.map.geocoder.geocode({ 'address': `${prov} ${dist}` }, function(results, status) {
                            if (status === 'OK') { 
                                const loc = results[0].geometry.location; 
                                window.app.map.instance.setCenter(loc); 
                                window.app.map.instance.setZoom(14); 
                                window.app.map.performSearch(loc, searchKeyword, typeKey, !!userInput); // userInputì´ ìˆìœ¼ë©´ type í•„í„° ë¬´ì‹œ ê°€ëŠ¥ì„± ì—´ì–´ë‘ 
                            }
                            else { 
                                const centerData = CITY_COORDINATES[prov] || CITY_COORDINATES['ì „êµ­']; 
                                window.app.map.instance.setCenter(centerData); 
                                window.app.map.instance.setZoom(prov === 'ì „êµ­' ? 7 : 10); 
                                window.app.map.performSearch(centerData, searchKeyword, typeKey, !!userInput); 
                            }
                        });
                    } else {
                        const centerData = CITY_COORDINATES[prov] || CITY_COORDINATES['ì „êµ­'];
                        window.app.map.instance.setCenter(centerData);
                        window.app.map.instance.setZoom(prov === 'ì „êµ­' ? 7 : 10);
                        window.app.map.performSearch(centerData, searchKeyword, typeKey, !!userInput);
                    }
                },
                performSearch: (location, keyword, typeKey, isCustomSearch) => {
                    // ì‚¬ìš©ì ì§ì ‘ ê²€ìƒ‰(isCustomSearch)ì¼ ê²½ìš° type ì œì•½ì„ í’€ê³  keyword ìœ„ì£¼ë¡œ ê²€ìƒ‰
                    const request = { location: location, radius: 3000, keyword: keyword };
                    
                    // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ êµ¬ê¸€ ë§µ 'type' í•„í„°ë¥¼ ì ìš© (ë” ì •í™•í•œ ì¹´í…Œê³ ë¦¬ ë§¤ì¹­ ìœ„í•´)
                    // ì‚¬ìš©ìê°€ 'í…Œë‹ˆìŠ¤'ë¼ê³  ì³¤ëŠ”ë° typeì´ 'gym'ì´ë©´ ê²°ê³¼ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì§ì ‘ ì…ë ¥ ì‹œ type ì œì™¸
                    if (!isCustomSearch && ['gym', 'park', 'stadium', 'spa', 'store'].includes(typeKey)) {
                        request.type = typeKey;
                    }
                    
                    window.app.map.service.nearbySearch(request, (results, status) => {
                        window.app.map.markers.forEach(m => m.setMap(null));
                        window.app.map.markers = [];
                        const list = document.getElementById('facility-list');
                        list.innerHTML = '';
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            const bookmarks = window.app.bookmarks.getList().map(b => b.place_id);
                            results.forEach((place, i) => {
                                const isBookmarked = bookmarks.includes(place.place_id);
                                const photoUrl = (place.photos && place.photos.length > 0) ? place.photos[0].getUrl({maxWidth: 200, maxHeight: 200}) : null;
                                
                                const placeData = { 
                                     place_id: place.place_id, 
                                     name: place.name, 
                                     vicinity: place.vicinity, 
                                     rating: place.rating,
                                    photoUrl: photoUrl 
                                 };
                                
                                const marker = new google.maps.Marker({ map: window.app.map.instance, position: place.geometry.location, label: (i+1).toString() });
                                const infoContent = `<div class="p-2 min-w-[200px]">${photoUrl ? `<div class="w-full h-24 mb-2 rounded-lg overflow-hidden"><img src="${photoUrl}" class="w-full h-full object-cover"></div>` : ''}<strong class="block text-sm text-gray-800 mb-1">${place.name}</strong><span class="text-xs text-gray-500 block mb-1">${place.vicinity || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</span>${place.rating ? `<div class="text-xs text-amber-500">â˜… ${place.rating} (${place.user_ratings_total})</div>` : ''}</div>`;
                                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                                marker.addListener('click', () => { if (window.app.map.currentInfoWindow) window.app.map.currentInfoWindow.close(); infoWindow.open(window.app.map.instance, marker); window.app.map.currentInfoWindow = infoWindow; window.app.reviews.load(place); window.app.map.instance.panTo(place.geometry.location); window.app.map.instance.setZoom(16); });
                                window.app.map.markers.push(marker);
                                const li = document.createElement('li');
                                li.className = "p-3 rounded-lg border border-slate-100 hover:bg-slate-50 cursor-pointer flex gap-3 items-start relative group";
                                const imgHtml = photoUrl ? `<img src="${photoUrl}" class="w-16 h-16 rounded-lg object-cover border border-slate-200 bg-slate-100 flex-shrink-0">` : `<div class="w-16 h-16 rounded-lg bg-slate-100 flex items-center justify-center text-slate-300 flex-shrink-0"><i class="fa-solid fa-image text-xl"></i></div>`;
                                li.innerHTML = `<div class="mt-1 w-5 h-5 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">${i+1}</div>${imgHtml}<div class="min-w-0 flex-1" onclick="google.maps.event.trigger(window.app.map.markers[${i}], 'click')"><div class="font-bold text-sm truncate text-slate-800">${place.name}</div><div class="text-xs text-slate-500 truncate mb-1">${place.vicinity || 'ì£¼ì†Œ ì—†ìŒ'}</div>${place.rating ? `<div class="text-xs text-amber-500"><i class="fa-solid fa-star mr-1"></i>${place.rating}</div>` : ''}</div><button id="btn-bookmark-${place.place_id}" onclick='window.app.bookmarks.toggle(${JSON.stringify(placeData).replace(/'/g, "&#39;")})' class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition z-10">${isBookmarked ? '<i class="fa-solid fa-star text-amber-400"></i>' : '<i class="fa-regular fa-star text-slate-300"></i>'}</button>`;
                                list.appendChild(li);
                            });
                        } else { list.innerHTML = `<li class="text-center text-xs text-slate-400 py-10">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>'${keyword}'ì— ëŒ€í•œ ì‹œì„¤ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>`; }
                    });
                }
            },

            reviews: {
                unsubscribe: null,
                load: (place) => {
                    window.app.state.currentPlace = place;
                    document.getElementById('review-target-name').textContent = place.name;
                    const list = document.getElementById('review-list');
                    list.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-primary"></i></div>';
                    if (isLocalMode) {
                        const saved = localStorage.getItem('sp_reviews');
                        const allReviews = saved ? JSON.parse(saved) : [];
                        const placeReviews = allReviews.filter(r => r.placeId === place.place_id);
                        window.app.reviews.renderList(placeReviews);
                        return;
                    }
                    
                    if (!window.fbUser) {
                        list.innerHTML = '<div class="text-center text-xs text-slate-400 py-10">ë¦¬ë·°ë¥¼ ë³´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                        return;
                    }

                    if (window.app.reviews.unsubscribe) { window.app.reviews.unsubscribe(); window.app.reviews.unsubscribe = null; }
                    try {
                        const colRef = window.fb.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'reviews');
                        window.app.reviews.unsubscribe = window.fb.onSnapshot(colRef, (snap) => {
                            const allDocs = [];
                            snap.forEach(doc => allDocs.push({id: doc.id, ...doc.data()}));
                            const placeReviews = allDocs.filter(r => r.placeId === place.place_id);
                            window.app.reviews.renderList(placeReviews);
                        }, (error) => { 
                             if (error.code === 'permission-denied') {
                                  list.innerHTML = '<div class="text-center text-xs text-slate-400 py-10">ë¦¬ë·°ë¥¼ ë³´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                             } else {
                                  console.error("Reviews Load Error:", error);
                             }
                        });
                    } catch (e) { console.error(e); }
                },
                renderList: (reviews) => {
                    const list = document.getElementById('review-list');
                    list.innerHTML = '';
                    if (reviews.length === 0) { list.innerHTML = '<div class="text-center text-xs text-slate-400 py-10">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë¦¬ë·°ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</div>'; return; }
                    
                    reviews.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    reviews.forEach(r => {
                        const isMyReview = (r.authorId === window.app.state.currentUserId);
                        const el = document.createElement('li');
                        el.className = "bg-slate-50 p-3 rounded-lg border border-slate-100";
                        const deleteBtn = isMyReview 
                             ? `<button onclick="window.app.reviews.delete('${r.id}')" class="ml-3 text-slate-400 hover:text-red-500 transition p-1 flex-shrink-0" aria-label="ë¦¬ë·° ì‚­ì œ"><i class="fa-solid fa-trash-can"></i></button>` 
                             : '';

                        el.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex flex-col">
                                    <span class="font-bold text-slate-800 text-sm">${r.author}</span>
                                    <div class="text-amber-400 text-xs font-bold mt-0.5">â˜… ${r.rating.toFixed(1)}</div>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-xs text-slate-400 whitespace-nowrap">${r.timestamp.split('T')[0]}</span>
                                    ${deleteBtn}
                                </div>
                            </div>
                            <div class="text-sm text-slate-600 whitespace-pre-wrap break-words leading-relaxed">${r.content}</div>
                        `;
                        list.appendChild(el);
                    });
                },
                write: () => {
                    if(!window.app.state.isLoggedIn) { window.app.ui.toast("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤."); window.app.auth.openModal('login'); return; }
                    if(!window.app.state.currentPlace) return window.app.ui.toast("ì§€ë„ì—ì„œ ì‹œì„¤ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
                    document.getElementById('modal-place-name').textContent = window.app.state.currentPlace.name;
                    document.getElementById('review-modal').classList.remove('hidden', 'pointer-events-none', 'opacity-0');
                    
                    document.getElementById('rev-content').value = '';
                    document.getElementById('rev-rating-slider').value = 5;
                    window.app.reviews.updateStarDisplay(5);
                },
                updateStarDisplay: (val) => {
                    const numVal = parseFloat(val).toFixed(1);
                    document.getElementById('rev-rating-text').textContent = numVal;
                    const starContainer = document.getElementById('star-display');
                    starContainer.innerHTML = '';
                    for(let i=1; i<=5; i++) {
                        if (i <= Math.floor(numVal)) { starContainer.innerHTML += '<i class="fa-solid fa-star text-amber-400"></i>'; }
                        else if (i === Math.ceil(numVal) && numVal % 1 !== 0) { starContainer.innerHTML += '<i class="fa-solid fa-star-half-stroke text-amber-400"></i>'; }
                        else { starContainer.innerHTML += '<i class="fa-regular fa-star text-slate-300"></i>'; }
                    }
                },
                closeModal: () => {
                    const modal = document.getElementById('review-modal');
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => modal.classList.add('hidden'), 250);
                },
                submit: async () => {
                    const rating = parseFloat(document.getElementById('rev-rating-slider').value);
                    const content = document.getElementById('rev-content').value;
                    if(!content) return window.app.ui.toast("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    
                    if (!isValidReview(content)) {
                        return window.app.ui.toast("ë‚´ìš©ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ë¶€ì ì ˆí•œ ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
                    }

                    const reviewData = {
                        id: Date.now().toString(),
                        placeId: window.app.state.currentPlace.place_id,
                        placeName: window.app.state.currentPlace.name,
                        author: window.app.state.currentUserName || 'ìµëª…',
                        authorId: window.app.state.currentUserId,
                        rating: rating,
                        content: content,
                        timestamp: new Date().toISOString()
                    };

                    if (isLocalMode) {
                        const saved = localStorage.getItem('sp_reviews');
                        const allReviews = saved ? JSON.parse(saved) : [];
                        allReviews.push(reviewData);
                        localStorage.setItem('sp_reviews', JSON.stringify(allReviews));
                        window.app.reviews.closeModal();
                        window.app.ui.toast("ë¦¬ë·°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        window.app.reviews.load(window.app.state.currentPlace);
                        return;
                    }
                    try {
                        const { id, ...fbData } = reviewData;
                        await window.fb.addDoc(window.fb.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'reviews'), fbData);
                        window.app.reviews.closeModal();
                        window.app.ui.toast("ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    } catch(e) { console.error(e); window.app.ui.toast("ë“±ë¡ ì‹¤íŒ¨"); }
                },
                delete: async (reviewId) => {
                    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    
                    if (isLocalMode) { 
                         const saved = localStorage.getItem('sp_reviews');
                         let allReviews = saved ? JSON.parse(saved) : [];
                         allReviews = allReviews.filter(r => r.id !== reviewId);
                         localStorage.setItem('sp_reviews', JSON.stringify(allReviews));
                         window.app.ui.toast("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                         if(window.app.state.currentPlace) window.app.reviews.load(window.app.state.currentPlace);
                         return;
                    }

                    try {
                        await window.fb.deleteDoc(window.fb.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'reviews', reviewId));
                        window.app.ui.toast("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch(e) { console.error(e); window.app.ui.toast("ì‚­ì œ ì‹¤íŒ¨"); }
                }
            },

            calendar: {
                render: () => {
                    const grid = document.getElementById('cal-grid');
                    const title = document.getElementById('cal-title');
                    grid.innerHTML = '';
                    const y = window.app.state.calendarDate.getFullYear();
                    const m = window.app.state.calendarDate.getMonth();
                    title.textContent = `${y}ë…„ ${m+1}ì›”`;
                    const firstDay = new Date(y, m, 1).getDay();
                    const lastDate = new Date(y, m+1, 0).getDate();
                    for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
                    for(let i=1; i<=lastDate; i++) {
                        const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                        const el = document.createElement('div');
                        const hasData = window.app.state.workoutData[dStr] && window.app.state.workoutData[dStr].length > 0;
                        el.className = `calendar-day ${dStr === window.app.state.selectedDate ? 'selected' : ''} ${dStr === new Date().toISOString().split('T')[0] ? 'today' : ''}`;
                        el.innerHTML = `<span class="text-sm z-10">${i}</span>${hasData ? '<div class="calendar-dot"></div>' : ''}`;
                        el.onclick = () => { window.app.state.selectedDate = dStr; window.app.calendar.render(); };
                        grid.appendChild(el);
                    }
                    window.app.calendar.renderList();
                },
                changeMonth: (delta) => { window.app.state.calendarDate.setMonth(window.app.state.calendarDate.getMonth() + delta); window.app.calendar.render(); },
                fetchData: async () => {
                    if (!window.app.state.isLoggedIn) return;
                    if (isLocalMode) {
                        const saved = localStorage.getItem('sp_workouts');
                        if (saved) window.app.state.workoutData = JSON.parse(saved);
                        window.app.calendar.render();
                        return;
                    }
                    if (!window.fbUser || !window.fb || !window.db) return;
                    const q = window.fb.query(window.fb.collection(window.db, 'artifacts', window.appId, 'users', window.fbUser.uid, 'workouts'));
                    const snap = await window.fb.getDocs(q);
                    window.app.state.workoutData = {};
                    snap.forEach(doc => { window.app.state.workoutData[doc.id] = doc.data().logs; });
                    window.app.calendar.render();
                },
                saveData: async () => {
                    const dStr = window.app.state.selectedDate;
                    const logs = window.app.state.workoutData[dStr] || [];
                    if (isLocalMode) { localStorage.setItem('sp_workouts', JSON.stringify(window.app.state.workoutData)); return; }
                    if(window.fb && window.db && window.fbUser) { await window.fb.setDoc(window.fb.doc(window.db, 'artifacts', window.appId, 'users', window.fbUser.uid, 'workouts', dStr), { logs }); }
                },
                renderList: () => {
                    const list = document.getElementById('workout-list');
                    const dStr = window.app.state.selectedDate;
                    document.getElementById('cal-selected-date').textContent = dStr;
                    list.innerHTML = '';
                    const logs = window.app.state.workoutData[dStr] || [];
                    if (logs.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 text-sm py-20"><i class="fa-regular fa-calendar-xmark text-2xl mb-2"></i><br>ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
                    logs.forEach((log, i) => {
                        const el = document.createElement('div');
                        el.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition group relative";
                        let detailText = log.detail || '';
                        if (!detailText) {
                            const parts = [];
                            if(log.weight) parts.push(`${log.weight}kg`);
                            if(log.sets) parts.push(`${log.sets}ì„¸íŠ¸`);
                            if(log.reps) parts.push(`${log.reps}íšŒ`);
                            if(log.time) parts.push(`${log.time}ë¶„`);
                            if(log.place) parts.push(`@${log.place}`);
                            detailText = parts.length > 0 ? parts.join(' Â· ') : 'ìƒì„¸ ì •ë³´ ì—†ìŒ';
                        }
                        el.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1"><div class="font-bold text-slate-800 text-base mb-2 flex items-center"><span class="w-1.5 h-1.5 rounded-full bg-primary mr-2"></span>${log.name}</div><div class="flex items-center bg-slate-50 rounded-lg px-3 py-2 w-fit text-xs text-slate-600">${detailText}</div></div><button onclick="window.app.calendar.delete(${i})" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition p-2 absolute top-2 right-2"><i class="fa-solid fa-trash-can"></i></button></div>`;
                        list.appendChild(el);
                    });
                },
                add: () => {
                    const name = document.getElementById('wo-name').value;
                    const place = document.getElementById('wo-place').value;
                    const weight = document.getElementById('wo-weight').value;
                    const sets = document.getElementById('wo-sets').value;
                    const reps = document.getElementById('wo-reps').value;
                    const time = document.getElementById('wo-time').value;
                    
                    if(!name) return window.app.ui.toast("ìš´ë™ ì¢…ëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
                    if (!isValidContent(name)) return window.app.ui.toast("ì˜¬ë°”ë¥¸ ìš´ë™ ëª…ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (í•œê¸€ ë˜ëŠ” ì˜ì–´ ìš´ë™ëª…).");
                    if (place && !isValidContent(place)) return window.app.ui.toast("ì˜¬ë°”ë¥¸ ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                    const dStr = window.app.state.selectedDate;
                    if(!window.app.state.workoutData[dStr]) window.app.state.workoutData[dStr] = [];
                    window.app.state.workoutData[dStr].push({ name, place, weight, sets, reps, time, timestamp: Date.now() });
                    document.getElementById('wo-name').value = ''; 
                    document.getElementById('wo-place').value = '';
                    document.getElementById('wo-weight').value = ''; document.getElementById('wo-sets').value = ''; document.getElementById('wo-reps').value = ''; document.getElementById('wo-time').value = '';
                    window.app.calendar.saveData(); 
                    window.app.calendar.render(); 
                    window.app.ui.toast("ìš´ë™ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (+XP)");
                },
                delete: (idx) => {
                    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    window.app.state.workoutData[window.app.state.selectedDate].splice(idx, 1);
                    window.app.calendar.saveData(); 
                    window.app.calendar.render(); 
                    window.app.ui.toast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            },
            
            tools: {
                switchFitnessTab: (tab) => {
                    ['bmi', 'diet', 'guide'].forEach(t => {
                        document.getElementById(`content-${t}`).classList.add('hidden');
                        const btn = document.getElementById(`tab-btn-${t}`);
                        if (btn) {
                            btn.classList.remove('tab-active');
                            btn.classList.add('tab-inactive');
                        }
                    });
                    const target = document.getElementById(`content-${tab}`);
                    if (target) target.classList.remove('hidden');
                    const activeBtn = document.getElementById(`tab-btn-${tab}`);
                    if (activeBtn) {
                        activeBtn.classList.remove('tab-inactive');
                        activeBtn.classList.add('tab-active');
                    }
                },
                switchCalTab: (tab) => {
                    const burnContent = document.getElementById('cal-content-burn');
                    const dailyContent = document.getElementById('cal-content-daily');
                    const burnTab = document.getElementById('cal-tab-burn');
                    const dailyTab = document.getElementById('cal-tab-daily');

                    if (tab === 'burn') {
                        burnContent.classList.remove('hidden');
                        dailyContent.classList.add('hidden');
                        
                        burnTab.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                        burnTab.classList.remove('text-slate-500');
                        
                        dailyTab.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                        dailyTab.classList.add('text-slate-500');
                    } else {
                        burnContent.classList.add('hidden');
                        dailyContent.classList.remove('hidden');

                        dailyTab.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                        dailyTab.classList.remove('text-slate-500');

                        burnTab.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                        burnTab.classList.add('text-slate-500');
                    }
                },
                calculateBurn: () => {
                    const weight = parseFloat(document.getElementById('burn-weight').value);
                    const met = parseFloat(document.getElementById('burn-activity').value);
                    const time = parseFloat(document.getElementById('burn-time').value);

                    if (!weight || !met || !time) return window.app.ui.toast("ëª¨ë“  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                    const calories = (met * weight * (time / 60)).toFixed(1);
                    const hourly = (met * weight).toFixed(1);

                    const rice = (calories / 300).toFixed(1);
                    const burger = (calories / 500).toFixed(1);
                    const pizza = (calories / 250).toFixed(1);

                    document.getElementById('burn-total').textContent = Math.round(calories);
                    document.getElementById('burn-hourly').textContent = Math.round(hourly);
                    document.getElementById('food-rice').textContent = rice;
                    document.getElementById('food-burger').textContent = burger;
                    document.getElementById('food-pizza').textContent = pizza;

                    document.getElementById('burn-result-placeholder').classList.add('hidden');
                    document.getElementById('burn-result-content').classList.remove('hidden');
                },
                calculateTDEE: () => {
                    const gender = document.getElementById('tdee-gender').value;
                    const age = parseFloat(document.getElementById('tdee-age').value);
                    const height = parseFloat(document.getElementById('tdee-height').value);
                    const weight = parseFloat(document.getElementById('tdee-weight').value);
                    const activity = parseFloat(document.getElementById('tdee-activity').value);

                    if (!age || !height || !weight) return window.app.ui.toast("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                    let bmr = (10 * weight) + (6.25 * height) - (5 * age);
                    if (gender === 'm') bmr += 5;
                    else bmr -= 161;

                    const tdee = bmr * activity;

                    document.getElementById('val-bmr').textContent = Math.round(bmr).toLocaleString();
                    document.getElementById('val-tdee').textContent = Math.round(tdee).toLocaleString();
                    
                    document.getElementById('val-cut').textContent = Math.round(tdee - 500).toLocaleString() + " kcal";
                    document.getElementById('val-maintain').textContent = Math.round(tdee).toLocaleString() + " kcal";
                    document.getElementById('val-bulk').textContent = Math.round(tdee + 300).toLocaleString() + " kcal";

                    document.getElementById('tdee-result').classList.remove('hidden');
                },
                togglePainNone: (checkbox) => {
                    if (checkbox.checked) {
                        document.querySelectorAll('#bmi-pain-area input[type="checkbox"]').forEach(el => {
                            if (el !== checkbox) el.checked = false;
                        });
                    }
                },
                calculateBMI: () => {
                    const h = document.getElementById('bmi-height').value / 100;
                    const w = document.getElementById('bmi-weight').value;
                    
                    if(!h || !w) return window.app.ui.toast("ì‹ ì¥ê³¼ ì²´ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
                    
                    const bmi = (w / (h*h)).toFixed(1);
                    const res = document.getElementById('bmi-result');
                    const val = document.getElementById('bmi-value');
                    const stat = document.getElementById('bmi-status');
                    const desc = document.getElementById('bmi-desc');
                    const adviceBalance = document.getElementById('bmi-advice-balance');
                    const adviceFatigue = document.getElementById('bmi-advice-fatigue');
                    const advicePainBox = document.getElementById('bmi-pain-advice-box');
                    const advicePain = document.getElementById('bmi-advice-pain');
                    
                    res.classList.remove('hidden');
                    val.textContent = bmi;

                    if(bmi < 18.5) { stat.textContent = "ì €ì²´ì¤‘"; stat.className = "text-lg font-bold text-blue-500 px-3 py-1 rounded-full bg-blue-50 border border-blue-100"; desc.textContent = "ì²´ì¤‘ì´ ì •ìƒë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤."; }
                    else if(bmi < 23) { stat.textContent = "ì •ìƒ"; stat.className = "text-lg font-bold text-green-500 px-3 py-1 rounded-full bg-green-50 border border-green-100"; desc.textContent = "ê±´ê°•í•œ ì²´ì¤‘ì…ë‹ˆë‹¤."; }
                    else if(bmi < 25) { stat.textContent = "ê³¼ì²´ì¤‘"; stat.className = "text-lg font-bold text-yellow-600 px-3 py-1 rounded-full bg-yellow-50 border border-yellow-100"; desc.textContent = "ì²´ì¤‘ ì¡°ì ˆì´ ê¶Œì¥ë©ë‹ˆë‹¤."; }
                    else { stat.textContent = "ë¹„ë§Œ"; stat.className = "text-lg font-bold text-red-500 px-3 py-1 rounded-full bg-red-50 border border-red-100"; desc.textContent = "ì²´ì¤‘ ê°ëŸ‰ì´ í•„ìš”í•©ë‹ˆë‹¤."; }
                    
                    const fatigue = parseInt(document.getElementById('bmi-fatigue').value);
                    let fatMsg = "";
                    if (fatigue <= 3) fatMsg = "ì»¨ë””ì…˜ ìµœìƒ! ê³ ê°•ë„ ìš´ë™ë„ ì¢‹ìŠµë‹ˆë‹¤.";
                    else if (fatigue <= 7) fatMsg = "ì»¨ë””ì…˜ ë³´í†µ. ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”.";
                    else fatMsg = "í”¼ë¡œë„ ë†’ìŒ. ì¶©ë¶„í•œ íœ´ì‹ê³¼ ìŠ¤íŠ¸ë ˆì¹­ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
                    if(adviceFatigue) adviceFatigue.innerHTML = fatMsg;

                    const painChecks = document.querySelectorAll('#bmi-pain-area input:checked');
                    const painAreas = Array.from(painChecks).map(cb => cb.value);
                    const customPain = document.getElementById('bmi-pain-custom').value.trim();
                    let painHTML = ""; let hasPain = false;
                    
                    const addPainAdvice = (area, advice, food) => { hasPain = true; painHTML += `<div class="mb-2 pb-2 border-b border-red-100 last:border-0"><div class="font-bold text-red-600 mb-1">â€¢ ${area}</div><div class="text-xs text-slate-600 mb-1">${advice}</div><div class="text-xs text-green-600 font-medium">ğŸ½ï¸ ìŒì‹: ${food}</div></div>`; };
                    
                    if (painAreas.includes('neck')) addPainAdvice('ëª©', 'ìŠ¤íŠ¸ë ˆì¹­ í•„ìˆ˜', PAIN_FOODS.neck);
                    if (painAreas.includes('shoulder')) addPainAdvice('ì–´ê¹¨', 'íšŒì „ê·¼ê°œ ì£¼ì˜', PAIN_FOODS.shoulder);
                    if (painAreas.includes('elbow')) addPainAdvice('íŒ”ê¿ˆì¹˜', 'ê·¸ë¦½ í˜ ë¹¼ê¸°', PAIN_FOODS.elbow);
                    if (painAreas.includes('wrist')) addPainAdvice('ì†ëª©', 'ë³´í˜¸ëŒ€ ì°©ìš©', PAIN_FOODS.wrist);
                    if (painAreas.includes('back')) addPainAdvice('ë“±/í—ˆë¦¬', 'ì²™ì¶” ì¤‘ë¦½', PAIN_FOODS.back);
                    if (painAreas.includes('pelvis')) addPainAdvice('ê³¨ë°˜', 'ë‹¤ë¦¬ ê¼¬ê¸° ê¸ˆì§€', PAIN_FOODS.pelvis);
                    if (painAreas.includes('knee')) addPainAdvice('ë¬´ë¦', 'ì í”„ ê¸ˆì§€', PAIN_FOODS.knee);
                    if (painAreas.includes('ankle')) addPainAdvice('ë°œëª©', 'ë°œëª© ê°•í™”', PAIN_FOODS.ankle);
                    if (painAreas.includes('muscle')) addPainAdvice('ì „ì‹ ê·¼ìœ¡í†µ', 'íœ´ì‹ê³¼ ìˆ˜ë©´', PAIN_FOODS.muscle);
                    if (customPain) { painHTML += `<div class="mb-2 pb-2 border-b border-red-100 last:border-0"><div class="font-bold text-red-600 mb-1">â€¢ ${customPain}</div><div class="text-xs text-slate-600">í†µì¦ ì§€ì† ì‹œ ìƒë‹´ í•„ìš”</div><div class="text-xs text-green-600 font-medium">ğŸ½ï¸ ìŒì‹: í•­ì—¼ ì‹í’ˆ(ìƒê°•, ë² ë¦¬ë¥˜)</div></div>`; hasPain = true; }

                    if (hasPain && advicePainBox && advicePain) { 
                         advicePainBox.classList.remove('hidden'); 
                         advicePain.innerHTML = painHTML; 
                     } else if (advicePainBox) { 
                         advicePainBox.classList.add('hidden'); 
                     }
                    
                    const macroRadio = document.querySelector('input[name="bmi-macro"]:checked');
                    const macro = macroRadio ? macroRadio.value : null;
                    let balMsg = "";
                    if (macro === 'carbs') balMsg += "íƒ„ìˆ˜í™”ë¬¼ ìœ„ì£¼ ì‹ë‹¨ì…ë‹ˆë‹¤. ë‹¨ë°±ì§ˆ ë³´ì¶©ì´ í•„ìš”í•©ë‹ˆë‹¤.";
                    else if (macro === 'protein') balMsg += "ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ì¶©ë¶„í•©ë‹ˆë‹¤. ìˆ˜ë¶„ ì„­ì·¨ì— ì‹ ê²½ ì“°ì„¸ìš”.";
                    else if (macro === 'fat') balMsg += "ì§€ë°© ì„­ì·¨ê°€ ë§ì•˜ìŠµë‹ˆë‹¤. ì˜¤ë©”ê°€3 ë“± ì¢‹ì€ ì§€ë°© ìœ„ì£¼ë¡œ ì„­ì·¨í•˜ì„¸ìš”.";
                    else balMsg += "ì‹ë‹¨ ì •ë³´ ì—†ìŒ.";
                    
                    if(adviceBalance) adviceBalance.innerHTML = balMsg;
                },
                calculateDiet: () => {
                    const h = parseInt(document.getElementById('diet-height').value);
                    const w = parseInt(document.getElementById('diet-weight').value);
                    const a = parseInt(document.getElementById('diet-age').value);
                    if (!h || !w || !a) return window.app.ui.toast("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
                    const goal = document.getElementById('diet-goal').value;
                    let cal = (10*w + 6.25*h - 5*a + 5) * 1.375; 
                    if(goal==='lose') cal-=500; else if(goal==='gain') cal+=300;
                    document.getElementById('diet-result').classList.remove('hidden');
                    document.getElementById('diet-calories').textContent = Math.round(cal);
                    document.getElementById('diet-carbs').textContent = Math.round(cal*0.5/4);
                    document.getElementById('diet-protein').textContent = Math.round(w*2);
                    document.getElementById('diet-fat').textContent = Math.round((cal*0.2)/9);
                    document.getElementById('diet-tip').textContent = goal === 'lose' ? "ì €íƒ„ìˆ˜ ê³ ë‹¨ë°± ì‹ë‹¨ì„ ê¶Œì¥í•©ë‹ˆë‹¤." : "ì¶©ë¶„í•œ íƒ„ìˆ˜í™”ë¬¼ê³¼ ë‹¨ë°±ì§ˆì„ ì„­ì·¨í•˜ì„¸ìš”.";
                    
                    const foodList = document.getElementById('diet-food-list');
                    if(foodList) {
                        foodList.innerHTML = '';
                        let foods = [];
                        if (goal === 'lose') foods = ['ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ', 'ê³ êµ¬ë§ˆ', 'í˜„ë¯¸ë°¥', 'ì•„ëª¬ë“œ', 'ê·¸ë¦­ìš”ê±°íŠ¸'];
                        else if (goal === 'gain') foods = ['ì†Œê³ ê¸° ìŠ¤í…Œì´í¬', 'íŒŒìŠ¤íƒ€', 'ë°”ë‚˜ë‚˜ ì‰ì´í¬', 'ê³„ë€', 'ì—°ì–´'];
                        else foods = ['ê· í˜•ì¡íŒ ì¼ë°˜ì‹', 'ìƒì„ êµ¬ì´', 'ë‘ë¶€ì¡°ë¦¼', 'ê³¼ì¼', 'ìš°ìœ '];
                        
                        foods.forEach(f => {
                            const li = document.createElement('li');
                            li.textContent = f;
                            foodList.appendChild(li);
                        });
                    }
                },
                initGuide: () => {
                    const container = document.getElementById('guide-buttons');
                    if (container.children.length > 0) return;
                    Object.keys(WORKOUT_GUIDE).forEach(part => {
                        const btn = document.createElement('button');
                        btn.textContent = part;
                        btn.className = "px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full text-sm font-bold transition mb-2 mr-2";
                        btn.onclick = () => window.app.tools.showGuide(part);
                        container.appendChild(btn);
                    });
                },
                showGuide: (part) => {
                    document.getElementById('guide-placeholder').classList.add('hidden');
                    document.getElementById('guide-result').classList.remove('hidden');
                    document.getElementById('guide-target-title').textContent = part + " ì¶”ì²œ ë£¨í‹´";
                    const list = document.getElementById('guide-list');
                    list.innerHTML = '';
                    WORKOUT_GUIDE[part].forEach(item => {
                        list.innerHTML += `<div class="bg-slate-50 p-4 rounded-lg border border-slate-100"><div class="font-bold text-slate-800 text-sm mb-1"><i class="fa-solid fa-check text-blue-500 mr-2"></i>${item.name}</div><div class="text-xs text-slate-500 ml-6">${item.desc}</div></div>`;
                    });
                }
            }
        };
    </script>
</body>
</html>